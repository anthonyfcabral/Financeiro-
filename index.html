<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FinApp (v10.12 Multi-CartÃµes)</title>
  <meta name="theme-color" content="#121212" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#121212; --card:#1e1e1e; --text:#e0e0e0; --border:#333; --input-bg:#2c2c2c;
      --primary:#2ecc71; --secondary:#e74c3c; --accent:#38bdf8; --weekend:#9b59b6;
    }
    
    /* ===== THEMES ===== */
    body[data-theme="dark"]{ /* default via :root */ }

    body[data-theme="light"]{
      --bg:#f7f7f7;
      --card:#ffffff;
      --text:#111827;
      --border:#e5e7eb;
      --input-bg:#f3f4f6;
      --primary:#16a34a;
      --secondary:#dc2626;
      --accent:#0284c7;
      --weekend:#7c3aed;
    }

    body[data-theme="amber"]{
      --bg:#1b1408;
      --card:#261b0c;
      --text:#f8f1e6;
      --border:#5a4320;
      --input-bg:#33230f;
      --primary:#34d399;
      --secondary:#fb7185;
      --accent:#fbbf24;
      --weekend:#a78bfa;
    }

    /* Small theme niceties */
    body[data-theme="light"] .section-bar{ background:#f3f4f6; }
    body[data-theme="light"] th{ background:#f3f4f6; }
    body[data-theme="light"] .notice{ background:rgba(2,132,199,.08); border-color:rgba(2,132,199,.25); }
body{font-family:Segoe UI,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:12px;padding-bottom:90px}
    .container{max-width:1200px;margin:auto}
    header{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    h1{margin:0;font-size:1.1rem}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{background:var(--input-bg);color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:rgba(56,189,248,.15);border-color:var(--accent);color:var(--accent);font-weight:700}
    .btn.warn{background:rgba(241,196,15,.12);border-color:#f1c40f;color:#f1c40f;font-weight:700}
    .btn.danger{background:rgba(231,76,60,.12);border-color:var(--secondary);color:var(--secondary);font-weight:700}
    select,input{background:var(--input-bg);border:1px solid var(--border);color:var(--text);padding:10px;border-radius:10px;outline:none}
    .tabs{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
    .tab{background:var(--card);border:1px solid var(--border);color:#888;padding:8px 14px;border-radius:10px;cursor:pointer}
    .tab.active{background:rgba(56,189,248,.15);border-color:var(--accent);color:var(--accent);font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .card h3{margin:0;font-size:.7rem;opacity:.7;text-transform:uppercase}
    .card p{margin:8px 0 0;font-size:1.35rem;font-weight:800; transition: filter 0.3s;}
    .muted{opacity:.7;font-size:.85rem}
    
    .section{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden; transition: max-height 0.3s ease;}
    .section-bar{display:flex;justify-content:space-between;align-items:center;background:#252525;border-bottom:1px solid var(--border);padding:10px 14px;gap:10px; cursor:pointer; user-select:none;}
    .section-title{font-weight:800;color:var(--accent); display:flex; align-items:center; gap:8px;}
    .content{padding:14px;}
    .section.collapsed .content { display: none; }
    .section.collapsed .section-bar { border-bottom: none; }
    .toggle-icon { transition: transform 0.3s; font-size: 0.8rem; opacity: 0.7; }
    .section.collapsed .toggle-icon { transform: rotate(-90deg); }

    .table-wrap { overflow-x: auto; border-radius:14px; border:1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; }
    td,th { border-bottom: 1px solid #2a2a2a; padding: 8px; font-size: 0.85rem; vertical-align: middle; }
    th { background: #252525; color: var(--accent); font-size: 0.75rem; text-align: left; white-space: nowrap; }
    
    .obs-cell-wrap { max-width: 80px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #888; cursor: pointer; padding: 4px; border-radius: 4px; border: 1px solid transparent; transition: all 0.2s; font-size: 0.8rem; }
    .obs-cell-wrap.expanded { white-space: normal; max-width: 200px; color: #fff; background: #222; border-color: #444; position: relative; z-index: 10; }

    td input { width: 100%; box-sizing: border-box; padding: 8px; margin:0; }
    .pill{display:inline-block;border:1px solid #444;border-radius:999px;padding:2px 8px;font-size:.7rem;opacity:.85; font-weight:700;}
    .synced{color:var(--weekend);font-weight:800}
    .row-weekend{background:rgba(155,89,182,.05)}
    .today{background:rgba(56,189,248,.08);border-left:4px solid var(--accent)}
    .chart-box{height:260px; transition: filter 0.3s;}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 900px){ .split{grid-template-columns:1fr} }
    
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal.active{display:flex}
    .modal-card{width:min(680px,94vw);max-height:90vh;overflow:auto;background:#18181b;border:1px solid var(--border);border-radius:14px;padding:14px}
    .modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);padding-bottom:10px;margin-bottom:12px;gap:10px}
    .tx-list{background:#121212;border:1px solid var(--border);border-radius:12px;padding:10px;max-height:260px;overflow:auto}
    .tx-item{display:flex;justify-content:space-between;gap:10px;padding:10px;border-bottom:1px solid #333}
    .tx-item:last-child{border-bottom:none}
    .tx-meta{font-size:.78rem;color:#888}
    .tx-actions button{background:none;border:none;cursor:pointer;font-size:1.05rem}
    .tx-actions .edit{color:#f1c40f}
    .tx-actions .del{color:var(--secondary)}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .full{grid-column:1/-1}
    .ok{background:var(--accent);color:#000;border:none}
    
    .cat-list-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #333;background:#222;}
    .cat-list-item:first-child{border-top-left-radius:10px; border-top-right-radius:10px;}
    .cat-list-item:last-child{border-bottom:none;border-bottom-left-radius:10px; border-bottom-right-radius:10px;}
    .notice{background:rgba(56,189,248,.12);border:1px solid rgba(56,189,248,.4);border-radius:14px;padding:12px;margin-bottom:12px}

    /* PRIVACIDADE */
    body.privacy-global-active .card p,
    body.privacy-global-active td:nth-child(2), 
    body.privacy-global-active td:nth-child(3),
    body.privacy-global-active input:not([type="checkbox"]),
    body.privacy-global-active .chart-box,
    body.privacy-global-active #macroRanking,
    body.privacy-global-active #dailyRanking,
    body.privacy-global-active #reportsContent {
        filter: blur(10px) !important;
        user-select: none;
        pointer-events: none;
    }
  
    @media (max-width: 520px){
      body{padding:10px;padding-bottom:90px}
      .container{max-width:100%}
      header{flex-direction:column;align-items:stretch}
      header .row{width:100%}
      header .row > *{flex:1;min-width:140px}
      .tabs{flex-wrap:nowrap;overflow:auto;-webkit-overflow-scrolling:touch}
      .tab{flex:1;text-align:center}
      .grid{grid-template-columns:1fr}
      .card p{font-size:1.25rem}
      .section-bar{flex-wrap:wrap;align-items:flex-start}
      .section-bar .btn{width:100%}
      input,select{width:100%;box-sizing:border-box}
      .form-grid{grid-template-columns:1fr}
      .chart-box{height:220px}
      .modal-card{width:96vw;padding:12px}
      .tx-item{flex-direction:column;align-items:flex-start}
      .tx-actions{width:100%;display:flex;justify-content:flex-end;gap:12px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="notice" id="migrationNotice" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <div>
          <b>Modo Preview:</b> nada Ã© migrado automaticamente.
          <div class="muted">Se vocÃª quiser testar com seus dados atuais, clique em â€œMigrar do legadoâ€. Isso cria apenas a chave <span class="pill">finapp_db_v9</span> (nÃ£o apaga as antigas).</div>
        </div>
        <div class="row">
          <button class="btn warn" id="btnMigrate">Migrar do legado</button>
          <button class="btn" id="btnDismissNotice">Fechar</button>
        </div>
      </div>
    </div>

    <header>
      <h1>ğŸ“± FinApp (v10.12) <span class="pill">Cards</span></h1>
      <div class="row">
        <select id="selYear"></select>
        <select id="selMonth"></select>
        <select id="selTheme" title="Tema">
          <option value="dark">ğŸŒ™ Dark</option>
          <option value="light">â˜€ï¸ Claro</option>
          <option value="amber">ğŸŸ  Ã‚mbar</option>
        </select>
        <button class="btn" id="btnOpenCats" onclick="openCatModal()">ğŸ“‚ Cats</button>
        <button class="btn" id="btnOpenCards" onclick="openCardModal()">ğŸ’³ Cards</button>
        <button class="btn" id="btnMasterEye" onclick="toggleGlobalPrivacy()" title="Ocultar Valores">ğŸ‘ï¸ Mestre</button>
        <button class="btn" id="btnExport">ğŸ“¥ BKP</button>
        <button class="btn" id="btnImport">ğŸ“¤ Rest</button>
      </div>
    </header>

    <div class="tabs">
      <button class="tab active" id="tabDaily">ğŸ“… DiÃ¡rio</button>
      <button class="tab" id="tabMonthly">ğŸ“Š Mensal</button>
      <button class="tab" id="tabReports">ğŸ“ˆ RelatÃ³rios</button>
    </div>

    <div id="viewDaily">
      <div class="grid" style="margin-bottom:12px">
        <div class="card">
          <h3>Meta Hoje</h3>
          <p id="dailyMeta">R$ 0,00</p>
          <div class="muted" id="dailyMetaHint"></div>
          <button class="btn" id="btnGoToday" style="width:100%; margin-top:10px">â¬‡ï¸ Ir para Hoje</button>
        </div>
        <div class="card">
          <h3>Saldo Restante</h3>
          <p id="dailySaldo">R$ 0,00</p>
          <div class="muted">Calculado no mÃªs selecionado</div>
        </div>
        <div class="card">
          <h3>Saldo Inicial do DiÃ¡rio</h3>
          <input id="inpStartBalance" type="number" style="width:100%; box-sizing:border-box; margin-top:8px" />
          <div class="muted" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn warn" id="btnUseMonthlySobra">Usar (Receitas - Fixos)</button>
            <select id="selWeekendFactor">
              <option value="1">Finde 1x</option>
              <option value="1.5">Finde 1.5x</option>
              <option value="2">Finde 2x</option>
              <option value="3">Finde 3x</option>
            </select>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-bar">
          <div class="section-title"><span class="toggle-icon">â–¼</span> ğŸ“‰ GrÃ¡fico diÃ¡rio</div>
          <span class="pill">Empilhado</span>
        </div>
        <div class="content">
          <div class="chart-box"><canvas id="chartDaily"></canvas></div>
          <div class="muted" style="text-align:center;margin-top:5px;font-size:0.75rem">Cores baseadas na categoria.</div>
        </div>
      </div>

      <div class="section" style="margin-top:12px">
        <div class="section-bar">
          <div class="section-title"><span class="toggle-icon">â–¼</span> ğŸ† Ranking por Categoria</div>
        </div>
        <div class="content">
          <div class="chart-box" style="height:220px; margin-bottom:12px"><canvas id="chartDailyPie"></canvas></div>
          
        </div>
      </div>

      <div class="section" style="margin-top:12px">
        <div class="section-bar">
          <div class="section-title"><span class="toggle-icon">â–¼</span> ğŸ“… LanÃ§amentos do mÃªs</div>
</div>
        <div class="content">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Dia</th>
                  <th>Meta</th>
                  <th>Total</th>
                  <th>Obs (Toque p/ ler)</th>
                </tr>
              </thead>
              <tbody id="dailyTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div id="viewMonthly" style="display:none">
      <div class="grid" style="margin-bottom:12px">
        <div class="card"><h3>Receitas</h3><p id="mIncome">R$ 0,00</p></div>
        <div class="card"><h3>Fixos + CartÃµes</h3><p id="mFixed">R$ 0,00</p></div>
        <div class="card"><h3>DiÃ¡rio</h3><p id="mDaily">R$ 0,00</p></div>
        <div class="card"><h3>Sobra</h3><p id="mSobra">R$ 0,00</p></div>
      </div>

      <div class="split">
        <div class="section">
          <div class="section-bar"><div class="section-title"><span class="toggle-icon">â–¼</span> ğŸ’° Receitas</div></div>
          <div class="content">
            <div class="form-grid">
              <input id="inpAdiant" type="number" placeholder="Adiant." />
              <input id="inpSal" type="number" placeholder="SalÃ¡rio" />
              <button class="btn full" id="btnAddExtra">+ Extra</button>
            </div>
            <div style="margin-top:10px; overflow:auto;">
              <table>
                <tbody id="tblExtras"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-bar"><div class="section-title"><span class="toggle-icon">â–¼</span> ğŸ”’ Fixas</div></div>
          <div class="content">
            <button class="btn" id="btnAddFixed" style="width:100%">+ Conta fixa</button>
            <div class="table-wrap" style="margin-top:10px">
              <table>
                <thead>
                    <tr>
                        <th style="width:30px; text-align:center">Pg</th>
                        <th>DescriÃ§Ã£o</th>
                        <th style="width:85px">Valor</th>
                        <th style="width:35px"></th>
                    </tr>
                </thead>
                <tbody id="tblFixed"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-bar"><div class="section-title"><span class="toggle-icon">â–¼</span> ğŸ’³ CartÃµes</div></div>
          <div class="content">
            <button class="btn" id="btnAddCard" style="width:100%">+ CartÃ£o</button>
            <div class="table-wrap" style="margin-top:10px">
              <table>
                <thead>
                    <tr>
                        <th style="width:30px; text-align:center">Pg</th>
                        <th>DescriÃ§Ã£o</th>
                        <th style="width:85px">Valor</th>
                        <th style="width:35px"></th>
                    </tr>
                </thead>
                <tbody id="tblCards"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-bar"><div class="section-title"><span class="toggle-icon">â–¼</span> ğŸ“Š VisÃ£o & Ranking</div></div>
          <div class="content">
            <div class="chart-box"><canvas id="chartMacro"></canvas></div>
            
            <div class="section-bar" style="margin-top:12px; border-radius:10px">
                <div class="section-title" style="font-size:0.9rem">ğŸ“… EvoluÃ§Ã£o Anual Detalhada</div>
            </div>
            <div class="chart-box" style="height:200px; margin-top:8px"><canvas id="chartYearlyBar"></canvas></div>
            
            <div id="macroRanking" style="margin-top:10px"></div>
          </div>
        </div>
      </div>

      
      <div class="section" style="margin-top:12px">
        <div class="section-bar"><div class="section-title"><span class="toggle-icon">â–¼</span> ğŸ· Porquinhos / CDB (por banco)</div></div>
        <div class="content">
          <div class="muted" style="margin-bottom:10px">Registre o saldo atual de cada banco/CDB no mÃªs selecionado. Isso nÃ£o afeta o cÃ¡lculo do DiÃ¡rio/Mensal â€” Ã© um controle separado.</div>
          <div id="pigsSummary" class="notice" style="margin-bottom:12px; display:none"></div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Banco</th>
                  <th style="width:140px">Saldo (R$)</th>
                  <th style="width:40px"></th>
                </tr>
              </thead>
              <tbody id="pigsTable"></tbody>
            </table>
          </div>
          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <input id="newPigBank" type="text" placeholder="Adicionar banco (ex: ItaÃº, Nubank...)" style="flex:1;min-width:180px" />
            <button class="btn primary" id="btnAddPigBank">Adicionar</button>
          </div>
        </div>
      </div>

<div class="section" style="margin-top:12px">
        <div class="section-bar"><div class="section-title"><span class="toggle-icon">â–¼</span> ğŸ“ Notas do mÃªs</div></div>
        <div class="content">
          <textarea id="txtNotes" style="width:100%; box-sizing:border-box; min-height:120px; background:var(--input-bg); border:1px solid #444; color:#ddd; padding:12px; border-radius:12px; resize:none" placeholder="Digite suas notas e observaÃ§Ãµes aqui..."></textarea>
        </div>
      </div>
    </div>

    <div id="viewReports" style="display:none">
        <div class="section">
            <div class="section-bar"><div class="section-title">ğŸ’³ AnÃ¡lise de Meios de Pagamento</div></div>
            <div class="content" id="reportsContent">
                <div class="split">
                    <div class="chart-box" style="height:220px"><canvas id="chartMethods"></canvas></div>
                </div>
            </div>
        </div>

        
        <div class="section" style="margin-top:12px">
            <div class="section-bar"><div class="section-title">ğŸ§¾ Gastos por Pix / CartÃ£o (detalhado)</div></div>
            <div class="content">
                <div class="row" style="margin-bottom:10px">
                    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
                    <select id="selSourceFilter">
                        <option value="ALL">Tudo</option>
                    </select>
                    <select id="selDayFrom" title="De (dia)"></select>
                    <select id="selDayTo" title="AtÃ© (dia)"></select>
                  </div>
                    <span class="muted" id="sourceHint"></span>
                </div>
                <div id="sourceSummary"></div>
                <div class="table-wrap" style="margin-top:10px">
                    <table>
                        <thead>
                            <tr>
                                <th>Dia</th>
                                <th>Fonte</th>
                                <th>Cat.</th>
                                <th>Desc</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody id="tblSourceReport"></tbody>
                    </table>
                </div>
            </div>
        </div>

  </div>

  <div class="modal" id="modalDay">
    <div class="modal-card">
      <div class="modal-header">
        <div><b>ğŸ“… Dia <span id="modalDayLabel"></span></b> <span class="pill" id="modalMonthLabel"></span></div>
        <button class="btn" id="btnCloseModal">Fechar</button>
      </div>
      <div class="tx-list" id="txList"></div>
      <div class="card" style="margin-top:12px">
        <h3 id="formTitle">Novo lanÃ§amento</h3>
        <div class="form-grid" style="margin-top:10px">
          <select id="txType"><option value="saida">ğŸ’¸ SaÃ­da</option><option value="entrada">ğŸ’° Entrada</option></select>
          <input id="txVal" type="text" inputmode="decimal" placeholder="Valor (ex: 10+5)" />
          <select id="txCat"></select>
          <select id="txMethod" onchange="toggleCardSelect()">
            <option value="Pix">ğŸ’  Pix</option>
            <option value="Credito">ğŸ’³ CrÃ©dito</option>
            <option value="Debito">ğŸ« DÃ©bito</option>
            <option value="Dinheiro">ğŸ’µ Dinheiro</option>
          </select>
          <select id="txCard" style="display:none"></select> <input id="txDesc" class="full" type="text" placeholder="ObservaÃ§Ã£o / DescriÃ§Ã£o" />
          <label class="full muted" style="display:flex;gap:10px;align-items:center">
            <input id="txPig" type="checkbox" /> ğŸ· Enviar para Porquinho
          </label>
          <button class="btn ok full" id="btnSaveTx">Adicionar / Salvar</button>
          <button class="btn full" id="btnCancelEdit" style="display:none">Cancelar ediÃ§Ã£o</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="modalCats">
    <div class="modal-card">
      <div class="modal-header">
        <div><b>ğŸ“‚ Gerenciar Categorias</b></div>
        <button class="btn" onclick="document.getElementById('modalCats').classList.remove('active')">Fechar</button>
      </div>
      <div class="card">
        <h3>Adicionar Nova</h3>
        <div style="display:flex;gap:8px;margin-top:8px">
            <input id="newCatName" type="text" placeholder="Ex: ğŸ¶ Pet" style="flex:1" />
            <button class="btn primary" id="btnAddCat">Adicionar</button>
        </div>
      </div>
      <h3 style="margin-top:16px;margin-bottom:8px">Categorias Existentes</h3>
      <div id="catListContainer" style="max-height:300px;overflow:auto;"></div>
    </div>
  </div>

  <div class="modal" id="modalCards">
    <div class="modal-card">
      <div class="modal-header">
        <div><b>ğŸ’³ Gerenciar CartÃµes</b></div>
        <button class="btn" onclick="document.getElementById('modalCards').classList.remove('active')">Fechar</button>
      </div>
      <div class="card">
        <h3>Adicionar Novo CartÃ£o</h3>
        <div style="display:flex;gap:8px;margin-top:8px">
            <input id="newCardName" type="text" placeholder="Ex: Nubank" style="flex:1" />
            <button class="btn primary" id="btnAddCardDB">Adicionar</button>
        </div>
      </div>
      <h3 style="margin-top:16px;margin-bottom:8px">CartÃµes Cadastrados</h3>
      <div id="cardListContainer" style="max-height:300px;overflow:auto;"></div>
    </div>
  </div>

  <script>
// ===== Mobile-safe wrappers =====
const __LS = (()=>{ try{ const t='__t__'; localStorage.setItem(t,'1'); localStorage.removeItem(t); return localStorage; }catch(e){ return null; } })();
function lsGet(k){ try{ return __LS ? __LS.getItem(k) : null; }catch(e){ return null; } }
function lsSet(k,v){ try{ if(__LS) __LS.setItem(k,v); }catch(e){} }
function hasChart(){ return typeof window.Chart !== 'undefined'; }
function safeDestroy(ch){ try{ ch && ch.destroy && ch.destroy(); }catch(e){} }

// ===== Theme (Dark / Claro / Ã‚mbar) =====
const THEME_KEY = 'finapp_theme_v1';
function applyTheme(theme){
  const t = (theme==='light' || theme==='amber' || theme==='dark') ? theme : 'dark';
  document.body.dataset.theme = t;
  lsSet(THEME_KEY, t);
  // Ajusta a cor da barra do navegador (quando suportado)
  const meta = document.querySelector('meta[name="theme-color"]');
  if(meta){
    const bg = getComputedStyle(document.body).getPropertyValue('--bg').trim() || '#121212';
    meta.setAttribute('content', bg);
  }
}
function initTheme(){
  const saved = lsGet(THEME_KEY) || 'dark';
  applyTheme(saved);
  const sel = document.getElementById('selTheme');
  if(sel){
    sel.value = (saved==='light'||saved==='amber'||saved==='dark') ? saved : 'dark';
    sel.onchange = ()=>applyTheme(sel.value);
  }
}

const DB_KEY = 'finapp_db_v9';
const monthsPT = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];
const monthsFull = ["Janeiro","Fevereiro","MarÃ§o","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
const defaultCats = ['ğŸ›’ Mercado','ğŸ” Alimentacao','ğŸš— Transporte','ğŸº Lazer','ğŸ  Casa','ğŸ’Š Saude','âœˆï¸ Viagem','âš™ï¸ Outros'];
const defaultCards = ['Inter','XP','Mercado Pago']; // Defaults // Defaults
const LEG_MAIN_KEY='financeDB_v8'; const LEG_CFG_PREFIX='survival_cfg_v4_'; const LEG_DETAILS_PREFIX='survival_details_v3_';

// CORES FIXAS (SYNC)
const catColors = { 'ğŸ›’ Mercado': '#3498db', 'Mercado': '#3498db', 'ğŸ” Alimentacao': '#e67e22', 'Alimentacao': '#e67e22', 'ğŸº Lazer': '#f1c40f', 'Lazer': '#f1c40f', 'ğŸš— Transporte': '#1abc9c', 'Transporte': '#1abc9c', 'ğŸ  Casa': '#9b59b6', 'Casa': '#9b59b6', 'ğŸ’Š Saude': '#e91e63', 'Saude': '#e91e63', 'âœˆï¸ Viagem': '#2ecc71', 'Viagem': '#2ecc71', 'âš™ï¸ Outros': '#95a5a6', 'Outros': '#95a5a6' };
const palette = ['#34495e', '#16a085', '#27ae60', '#2980b9', '#8e44ad', '#d35400', '#c0392b'];
function getCatColor(c){ if(catColors[c]) return catColors[c]; let hash = 0; for (let i = 0; i < c.length; i++) hash = c.charCodeAt(i) + ((hash << 5) - hash); return palette[Math.abs(hash) % palette.length]; }

function getMethodIcon(m){
    const s = String(m||'').toLowerCase().trim();
    if(s.startsWith('pix')) return 'ğŸ’ ';
    if(s.startsWith('cred')) return 'ğŸ’³';
    if(s.startsWith('deb')) return 'ğŸ«';
    if(s.startsWith('din')) return 'ğŸ’µ';
    return '';
}
function getMethodName(m){
    const s = String(m||'').toLowerCase().trim();
    if(s.startsWith('pix')) return 'Pix';
    if(s.startsWith('cred')) return 'CrÃ©dito';
    if(s.startsWith('deb')) return 'DÃ©bito';
    if(s.startsWith('din')) return 'Dinheiro';
    return String(m||'');
}

let state = { db: null, year: new Date().getFullYear(), month: new Date().getMonth(), editing: { day: null, txId: null } };
let charts = { daily:null, dailyPie:null, macro:null, yearlyBar:null, methods:null };

function toggleGlobalPrivacy() {
    const isActive = document.body.classList.toggle('privacy-global-active');
    const btn = document.getElementById('btnMasterEye');
    if(isActive){ btn.style.background='var(--secondary)'; btn.style.borderColor='var(--secondary)'; }
    else{ btn.style.background='#2c2c2c'; btn.style.borderColor='#444'; }
}

const pad2=(n)=>String(n).padStart(2,'0');
const monthKey=(y,m)=>`${y}-${pad2(m+1)}`;
const daysInMonth=(y,m)=>new Date(y, m+1, 0).getDate();
function money(v){ return (v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function parseAmount(expr){ const s=String(expr||'').replace(/\s+/g,'').replace(',', '.'); if(!s)throw new Error('empty'); if(!/^[0-9+\-\.]+$/.test(s))throw new Error('invalid'); const sum=(s.match(/[+\-]?\d*\.?\d+/g)||[]).reduce((a,p)=>a+(parseFloat(p)||0),0); if(!Number.isFinite(sum))throw new Error('invalid'); return sum; }
function uid(){ return `${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`; }
function escapeHtml(str){ return String(str||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;"); }

function loadDB(){ 
    const raw=lsGet(DB_KEY); let data={version:12,categories:[...defaultCats],cards:[...defaultCards],pigsBanks:[...defaultCards],months:{}}; 
    if(raw){ 
        try{ 
            const parsed=JSON.parse(raw); data={...data,...parsed}; 
            if(!data.categories) data.categories=[...defaultCats]; 
            if(!data.cards) data.cards=[...defaultCards];
            if(!data.pigsBanks) data.pigsBanks=[...defaultCards];
        }catch{} 
    } 
    return data; 
}
function saveDB(){ lsSet(DB_KEY, JSON.stringify(state.db)); }
function ensureMonthModel(y,m){ const k=monthKey(y,m); if(!state.db.months[k]) state.db.months[k]={ cfg:{startBalance:0,weekendFactor:1}, incomes:{adiant:0,sal:0,extras:[]}, expenses:{fixed:[],cards:[]}, notes:"", txByDay:{}, manualDaily:{}, pigsByBank:{} }; return state.db.months[k]; }
function getMonth(){ return ensureMonthModel(state.year, state.month); }

function sumExtras(list){ return (list||[]).reduce((a,x)=>a + (Number(x.val)||0),0); }
function sumCards(list){ return (list||[]).reduce((a,x)=>a + ((!x.paid?1:0) * (Number(x.val)||0)),0); }
function sumFixed(list){ return (list||[]).reduce((a,x)=>a + ((!x.paid?1:0) * (Number(x.val)||0)),0); }
function dayTotalFromTx(list){ return (list||[]).reduce((acc,tx)=>{ const v=Number(tx.val)||0; return acc+(tx.type==='entrada'?-v:v); },0); }
function dayObsFromTx(list){ 
    if(!list||!list.length)return ''; 
    return list.map(tx=>{
        let obs = getMethodIcon(tx.method);
        if(tx.method === 'Credito' && tx.card) obs += ` ${tx.card}`;
        obs += ` ${tx.cat}`;
        if(tx.desc) obs += ` (${tx.desc})`;
        return obs;
    }).join(' â€¢ '); 
}

function buildMonthlySummary(model){
  const income=(Number(model.incomes.adiant)||0)+(Number(model.incomes.sal)||0)+sumExtras(model.incomes.extras);
  const fixedOnly = sumFixed(model.expenses.fixed);
  const cardsOnly = sumCards(model.expenses.cards);
  const fixedTotal = fixedOnly + cardsOnly;
  const dim=daysInMonth(state.year, state.month);
  const bar=[]; const cats={}; let dailyTotal=0;
  for(let d=1; d<=dim; d++){
    const list=model.txByDay[String(d)];
    let dv=0;
    if(list&&list.length){
      dv=dayTotalFromTx(list);
      list.forEach(tx=>{ if(tx.type==='saida') cats[tx.cat]=(cats[tx.cat]||0)+(Number(tx.val)||0); });
    } else dv=Number(model.manualDaily[String(d)]||0);
    bar.push(dv); dailyTotal+=dv;
  }
  return {income, fixedOnly, cardsOnly, fixedTotal, dailyTotal, sobra:income-fixedTotal-dailyTotal, bar, cats};
}

function computeDailyMetaAndSaldo(model){
  const dim=daysInMonth(state.year, state.month);
  const start=Number(model.cfg.startBalance)||0; const factor=Number(model.cfg.weekendFactor)||1;
  let saldo=start; const metas=[]; const totals=[];
  for(let day=1; day<=dim; day++){
    const list=model.txByDay[String(day)];
    const total=(list&&list.length)?dayTotalFromTx(list):Number(model.manualDaily[String(day)]||0);
    totals.push(total);
    let wd=0, we=0;
    for(let k=day; k<=dim; k++){ const dow=new Date(state.year,state.month,k).getDay(); if(dow===0||dow===6)we++; else wd++; }
    const w=wd+(we*factor); const base=w>0?(saldo/w):0;
    const isW=(new Date(state.year,state.month,day).getDay()===0||new Date(state.year,state.month,day).getDay()===6);
    metas.push(isW?base*factor:base);
    saldo-=total;
  }
  return {metas,totals,saldo};
}

function getYearlyData() {
    const labels = monthsPT;
    const fixed = [], cards = [], daily = [];
    for (let m = 0; m < 12; m++) {
        const k = monthKey(state.year, m);
        const model = state.db.months[k];
        if (!model) { fixed.push(0); cards.push(0); daily.push(0); continue; }
        const s = buildMonthlySummary(model);
        fixed.push(s.fixedOnly); cards.push(s.cardsOnly); daily.push(s.dailyTotal);
    }
    return { labels, fixed, cards, daily };
}

function exportV9(){ saveDB(); const b=new Blob([JSON.stringify(state.db,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`FINAPP_BKP_${monthKey(state.year,state.month)}.json`; a.click(); }
function importV9(){ const i=document.createElement('input'); i.type='file'; i.accept='.json'; i.onchange=e=>{ const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=ev=>{ try{ const o=JSON.parse(ev.target.result); if(!o||!o.months)throw 0; lsSet(DB_KEY,JSON.stringify(o)); location.reload(); }catch{alert('Erro no arquivo');} }; r.readAsText(f); }; i.click(); }

function setupSelectors(){
  const sy=document.getElementById('selYear'), sm=document.getElementById('selMonth');
  sy.innerHTML=''; for(let y=2025;y<=2030;y++) sy.add(new Option(y,y)); sy.value=state.year;
  sm.innerHTML=monthsFull.map((m,i)=>`<option value="${i}">${m}</option>`).join(''); sm.value=state.month;
  sy.onchange=()=>{state.year=Number(sy.value);renderAll();}; sm.onchange=()=>{state.month=Number(sm.value);renderAll();};
}
function setupTabs(){
  const td=document.getElementById('tabDaily'), tm=document.getElementById('tabMonthly'), tr=document.getElementById('tabReports');
  const vd=document.getElementById('viewDaily'), vm=document.getElementById('viewMonthly'), vr=document.getElementById('viewReports');
  
  const switchTab = (tab, view) => {
      [td,tm,tr].forEach(t=>t.classList.remove('active'));
      [vd,vm,vr].forEach(v=>v.style.display='none');
      tab.classList.add('active'); view.style.display='';
  };
  
  td.onclick=()=>{ switchTab(td, vd); renderDaily(); };
  tm.onclick=()=>{ switchTab(tm, vm); renderMonthly(); };
  tr.onclick=()=>{ switchTab(tr, vr); renderReports(); };
}
function setupDailyConfig(){
  const i=document.getElementById('inpStartBalance'), s=document.getElementById('selWeekendFactor'), b=document.getElementById('btnUseMonthlySobra');
  i.onchange=()=>{getMonth().cfg.startBalance=Number(i.value)||0;saveDB();renderDaily();};
  s.onchange=()=>{getMonth().cfg.weekendFactor=Number(s.value)||1;saveDB();renderDaily();};
  b.onclick=()=>{const m=getMonth(), sm=buildMonthlySummary(m); m.cfg.startBalance=Math.max(0,sm.income-sm.fixedTotal); saveDB();renderDaily();};
  document.getElementById('btnGoToday').onclick=()=>{
    const t=new Date(); if(t.getFullYear()!==state.year||t.getMonth()!==state.month){alert('MÃªs errado');return;}
    const el=document.querySelector('tr.today'); if(el)el.scrollIntoView({behavior:'smooth',block:'center'});
  };
}

// CATS & CARDS MODALS
function openCatModal(){ document.getElementById('modalCats').classList.add('active'); renderCatManager(); }
function renderCatManager(){ document.getElementById('catListContainer').innerHTML=(state.db.categories||[]).map((c,i)=>`<div class="cat-list-item"><span>${escapeHtml(c)}</span><button class="btn danger" onclick="delCat(${i})">ğŸ—‘ï¸</button></div>`).join(''); }
function addCat(){ const v=document.getElementById('newCatName').value.trim(); if(v && !state.db.categories.includes(v)){ state.db.categories.push(v); saveDB(); document.getElementById('newCatName').value=''; renderCatManager(); } }
window.delCat=(i)=>{if(confirm('Excluir cat?')){state.db.categories.splice(i,1);saveDB();renderCatManager();}};

function openCardModal(){ document.getElementById('modalCards').classList.add('active'); renderCardManager(); }
function renderCardManager(){ document.getElementById('cardListContainer').innerHTML=(state.db.cards||[]).map((c,i)=>`<div class="cat-list-item"><span>ğŸ’³ ${escapeHtml(c)}</span><button class="btn danger" onclick="delCard(${i})">ğŸ—‘ï¸</button></div>`).join(''); }
function addCardDB(){ const v=document.getElementById('newCardName').value.trim(); if(v && !state.db.cards.includes(v)){ state.db.cards.push(v); saveDB(); document.getElementById('newCardName').value=''; renderCardManager(); } }
window.delCard=(i)=>{if(confirm('Excluir cartÃ£o?')){state.db.cards.splice(i,1);saveDB();renderCardManager();}};

// TRANSACTIONS
function toggleCardSelect(){
    const method = document.getElementById('txMethod').value;
    const cardSelect = document.getElementById('txCard');
    if(method === 'Credito'){
        cardSelect.style.display = '';
        // Preenche cartÃµes
        cardSelect.innerHTML = (state.db.cards||[]).map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
    } else {
        cardSelect.style.display = 'none';
    }
}

function openDayModal(d){
  state.editing.day=d; state.editing.txId=null;
  document.getElementById('modalDayLabel').textContent=pad2(d); document.getElementById('modalMonthLabel').textContent=`${monthsFull[state.month]}/${state.year}`;
  const sel=document.getElementById('txCat'); sel.innerHTML=(state.db.categories||[]).map(c=>`<option>${escapeHtml(c)}</option>`).join('');
  document.getElementById('modalDay').classList.add('active');
  resetTxForm(); renderTxList(getMonth().txByDay[String(d)]||[]);
}
function closeDayModal(){ document.getElementById('modalDay').classList.remove('active'); renderDaily(); }
function resetTxForm(){ 
    document.getElementById('formTitle').textContent='Novo'; 
    document.getElementById('txVal').value=''; 
    document.getElementById('txDesc').value=''; 
    document.getElementById('txPig').checked=false; 
    document.getElementById('txMethod').value='Pix';
    toggleCardSelect();
    document.getElementById('btnCancelEdit').style.display='none'; 
    state.editing.txId=null; 
}
function renderTxList(l){
  const b=document.getElementById('txList');
  if(!l||!l.length){ b.innerHTML='<div class="muted" style="text-align:center;padding:10px">Vazio</div>'; return; }
  b.innerHTML=l.map(x=>{
      let meta = `${getMethodIcon(x.method)} `;
      if(x.method === 'Credito' && x.card) meta += `${x.card} â€¢ `;
      meta += `${x.cat} ${x.isPig?'(ğŸ·)':''}`;
      return `<div class="tx-item"><div><b style="color:${x.type==='entrada'?'var(--primary)':'#fff'}">${x.type==='entrada'?'+':'-'} ${money(x.val)}</b><div class="tx-meta">${meta}</div>${x.desc?`<div>${escapeHtml(x.desc)}</div>`:''}</div><div class="tx-actions"><button class="edit" onclick="editTx('${x.id}')">âœï¸</button><button class="del" onclick="delTx('${x.id}')">ğŸ—‘ï¸</button></div></div>`;
  }).join('');
}
window.editTx=(id)=>{
  const tx=(getMonth().txByDay[String(state.editing.day)]||[]).find(x=>x.id===id); if(!tx)return;
  state.editing.txId=id; document.getElementById('formTitle').textContent='Editar';
  document.getElementById('txType').value=tx.type; document.getElementById('txVal').value=tx.val; 
  document.getElementById('txMethod').value=tx.method;
  toggleCardSelect();
  if(tx.method === 'Credito' && tx.card) document.getElementById('txCard').value = tx.card;
  
  document.getElementById('txDesc').value=tx.desc||''; document.getElementById('txPig').checked=!!tx.isPig; document.getElementById('btnCancelEdit').style.display='';
  const sel=document.getElementById('txCat'); if(![...sel.options].some(o=>o.value===tx.cat)) sel.add(new Option(tx.cat,tx.cat)); sel.value=tx.cat;
};
window.delTx=(id)=>{ if(confirm('Apagar?')){ const m=getMonth(), d=String(state.editing.day); m.txByDay[d]=m.txByDay[d].filter(x=>x.id!==id); saveDB(); renderTxList(m.txByDay[d]); resetTxForm(); } };

function saveTx(){
  const m=getMonth(), d=String(state.editing.day); let amt; try{amt=parseAmount(document.getElementById('txVal').value);}catch{alert('Valor err');return;}
  const method = document.getElementById('txMethod').value;
  const card = (method === 'Credito') ? document.getElementById('txCard').value : null;

  const tx={ id:state.editing.txId||uid(), val:Math.abs(amt), type:document.getElementById('txType').value, cat:document.getElementById('txCat').value, method:method, card:card, desc:document.getElementById('txDesc').value||'', isPig:document.getElementById('txPig').checked, ts:Date.now() };
  if(!m.txByDay[d]) m.txByDay[d]=[];
  if(state.editing.txId){ const i=m.txByDay[d].findIndex(x=>x.id===state.editing.txId); if(i>=0)m.txByDay[d][i]=tx; } else m.txByDay[d].push(tx);
  delete m.manualDaily[d]; saveDB(); renderTxList(m.txByDay[d]); resetTxForm();
}

function setupModal(){
  document.getElementById('btnCloseModal').onclick=closeDayModal; document.getElementById('btnSaveTx').onclick=saveTx;
  document.getElementById('btnCancelEdit').onclick=()=>{state.editing.txId=null;resetTxForm();};
  document.getElementById('btnAddCat').onclick=addCat;
  document.getElementById('btnAddCardDB').onclick=addCardDB;
  document.getElementById('modalCats').addEventListener('click',e=>{if(e.target.id==='modalCats')document.getElementById('modalCats').classList.remove('active');});
  document.getElementById('modalCards').addEventListener('click',e=>{if(e.target.id==='modalCards')document.getElementById('modalCards').classList.remove('active');});
}

function setupMonthly(){
  const ia=document.getElementById('inpAdiant'), is=document.getElementById('inpSal'), tn=document.getElementById('txtNotes');
  const up=()=>{ getMonth().incomes.adiant=Number(ia.value)||0; getMonth().incomes.sal=Number(is.value)||0; saveDB(); renderMonthly(); };
  ia.onchange=up; is.onchange=up; tn.onchange=()=>{getMonth().notes=tn.value;saveDB();};
  document.getElementById('btnAddExtra').onclick=()=>{getMonth().incomes.extras.push({desc:'Novo',val:0});saveDB();renderMonthly();};
  document.getElementById('btnAddFixed').onclick=()=>{getMonth().expenses.fixed.push({desc:'Nova',val:0,paid:false});saveDB();renderMonthly();};
  document.getElementById('btnAddCard').onclick=()=>{getMonth().expenses.cards.push({desc:'CartÃ£o',val:0,paid:false});saveDB();renderMonthly();};
  const pb=document.getElementById('btnAddPigBank'); if(pb) pb.onclick=addPigBank;
}

function renderTableDynamic(id,list,k){
  const tb=document.getElementById(id); tb.innerHTML='';
  const hasPaid = (k==='fixed' || k==='cards');
  list.forEach((x,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`${hasPaid?`<td style="vertical-align:middle;text-align:center"><input type="checkbox" ${x.paid?'checked':''} onchange="updList('${k}',${i},'paid',this.checked)" style="width:auto;margin:0"></td>`:''}<td><input type="text" value="${escapeHtml(x.desc)}" onchange="updList('${k}',${i},'desc',this.value)" class="m-desc" ${x.paid?'style="text-decoration:line-through;opacity:0.6"':''}></td><td><input type="number" step="0.01" value="${x.val}" onchange="updList('${k}',${i},'val',this.value)" class="m-val"></td><td style="text-align:right"><button class="btn danger" onclick="delList('${k}',${i})" style="padding:4px 8px;font-size:0.8rem">X</button></td>`;
    tb.appendChild(tr);
  });
}
window.updList=(k,i,f,v)=>{ const l=k==='extras'?getMonth().incomes.extras:(k==='fixed'?getMonth().expenses.fixed:getMonth().expenses.cards); l[i][f]=f==='val'?Number(v)||0:v; saveDB(); renderMonthly(); };
window.delList=(k,i)=>{ if(confirm('Apagar?')){ const l=k==='extras'?getMonth().incomes.extras:(k==='fixed'?getMonth().expenses.fixed:getMonth().expenses.cards); l.splice(i,1); saveDB(); renderMonthly(); } };

// === RELATÃ“RIOS ===

function normalizeMethod(m){
  const s = String(m||'').toLowerCase().trim();
  if(s.startsWith('pix')) return 'Pix';
  if(s.startsWith('cred')) return 'Credito';
  if(s.startsWith('deb')) return 'Debito';
  if(s.startsWith('din')) return 'Dinheiro';
  // fallback
  if(m==='Pix'||m==='Credito'||m==='Debito'||m==='Dinheiro') return m;
  return 'Pix';
}
function normalizeCard(c){
  const s = String(c||'').trim();
  return s || null;
}

// === RELATÃ“RIOS ===
function renderReports(){
    const m = getMonth();
    const dim = daysInMonth(state.year, state.month);

    // Agrega dados por MÃ©todo e por Fonte (Pix ou cada cartÃ£o)
    const stats = { Pix:{val:0, cats:{}}, Credito:{val:0, cats:{}, byCard:{}}, Debito:{val:0, cats:{}}, Dinheiro:{val:0, cats:{}} };
    const sources = {}; // {key:{label,val,cats,items:[]}}
    const fullList = []; // extrato geral (saÃ­das)

    const addToCats = (obj, cat, val)=>{ obj[cat] = (obj[cat]||0) + val; };

    for(let d=1; d<=dim; d++){
        const list = m.txByDay[String(d)] || [];
        list.forEach(tx => {
            if(tx.type === 'saida'){
                const met = normalizeMethod(tx.method);
                const card = normalizeCard(tx.card || tx.cardName || tx.bank);
                if(!stats[met]) stats[met] = {val:0, cats:{}};
                stats[met].val += Number(tx.val)||0;
                addToCats(stats[met].cats, tx.cat, Number(tx.val)||0);

                // CrÃ©dito por cartÃ£o
                if(met === 'Credito'){
                    const cName = card || 'Sem cartÃ£o';
                    stats.Credito.byCard[cName] = (stats.Credito.byCard[cName]||0) + (Number(tx.val)||0);
                }

                // Fonte: Pix / DÃ©bito / Dinheiro / ou nome do cartÃ£o (CrÃ©dito)
                const sourceKey = (met==='Credito') ? (card || 'Sem cartÃ£o') : met;
                if(!sources[sourceKey]) sources[sourceKey] = { label: sourceKey, val:0, cats:{}, items:[] };
                sources[sourceKey].val += Number(tx.val)||0;
                addToCats(sources[sourceKey].cats, tx.cat, Number(tx.val)||0);
                sources[sourceKey].items.push({ day:d, ...tx, method:met, card });

                fullList.push({ day:d, ...tx, method:met, card });
            }
        });
    }

    // Chart Methods
    if(hasChart()){
        const ctx = document.getElementById('chartMethods').getContext('2d'); 
        safeDestroy(charts.methods);
        const labels = ['Pix', 'CrÃ©dito', 'DÃ©bito', 'Dinheiro'];
        const data = [stats.Pix.val, stats.Credito.val, stats.Debito.val, stats.Dinheiro.val];
        const colors = ['#38bdf8', '#e74c3c', '#f1c40f', '#2ecc71'];
        charts.methods = new Chart(ctx, {
            type: 'doughnut', 
            data: { labels, datasets:[{ data, backgroundColor:colors, borderWidth:0 }] },
            options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{position:'right', labels:{color:'#aaa'}} } }
        });
    }

    // Extrato Geral (tudo)
    fullList.sort((a,b) => a.day - b.day);
    // === Gastos por Pix / CartÃ£o (detalhado) ===
    const sel = document.getElementById('selSourceFilter');
    const selFrom = document.getElementById('selDayFrom');
    const selTo = document.getElementById('selDayTo');
    const hint = document.getElementById('sourceHint');
    const sumBox = document.getElementById('sourceSummary');
    const tb = document.getElementById('tblSourceReport');

    if(sel && tb){
        // monta opÃ§Ãµes: Pix, DÃ©bito, Dinheiro e cartÃµes (CrÃ©dito)
        const keys = Object.keys(sources).sort((a,b)=> (sources[b].val||0)-(sources[a].val||0));
        const keep = ['Pix','Debito','Dinheiro'];
        const ordered = [...keep.filter(k=>sources[k]), ...keys.filter(k=>!keep.includes(k))];
        // Range de dias (no mÃªs selecionado)
        const dimNow = dim;
        const prevFrom = Number(selFrom.value || 1);
        const prevTo = Number(selTo.value || dimNow);
        selFrom.innerHTML = Array.from({length: dimNow}, (_,i)=>`<option value="${i+1}">De ${String(i+1).padStart(2,'0')}</option>`).join('');
        selTo.innerHTML   = Array.from({length: dimNow}, (_,i)=>`<option value="${i+1}">AtÃ© ${String(i+1).padStart(2,'0')}</option>`).join('');
        selFrom.value = String(Math.min(Math.max(prevFrom,1), dimNow));
        selTo.value   = String(Math.min(Math.max(prevTo,1), dimNow));
        if(Number(selFrom.value) > Number(selTo.value)) selTo.value = selFrom.value;


        sel.innerHTML = `<option value="ALL">Tudo</option>` + ordered.map(k=>`<option value="${escapeHtml(k)}">${escapeHtml(k)}</option>`).join('');
        const renderSource = ()=>{
            const val = sel.value;
            const from = Number(selFrom.value||1);
            const to = Number(selTo.value||dim);
            const inRange = (tx)=> (tx.day>=from && tx.day<=to);

            const baseList = (val==='ALL')
              ? fullList
              : (sources[val]?.items || []);
            const list = baseList.filter(inRange);

            // resumo (cards) (aplica range)
            if(sumBox){
                const cards = ordered.map(k=>{
                    const v = (sources[k]?.items || []).filter(inRange).reduce((a,x)=>a+(Number(x.val)||0),0);
                    return `<div style="display:flex;justify-content:space-between;border-bottom:1px solid #222;padding:8px 0;font-size:.9rem">
                        <div>${k==='Pix'?'ğŸ’  Pix':(k==='Debito'?'ğŸ« DÃ©bito':(k==='Dinheiro'?'ğŸ’µ Dinheiro':'ğŸ’³ '+escapeHtml(k)))}</div>
                        <div style="font-weight:800;color:#ddd">${money(v)}</div>
                    </div>`;
                }).join('');
                sumBox.innerHTML = cards || '<div class="muted">Sem dados.</div>';
            }

            if(hint){
                const periodTxt = (from===1 && to===dim) ? '' : ` (PerÃ­odo: ${pad2(from)}â€“${pad2(to)})`;
                hint.textContent = (val==='ALL') ? `Mostrando saÃ­das do mÃªs${periodTxt}.` : `Mostrando apenas: ${val}${periodTxt}.`;
            }

            // tabela
            const out = (list||[]).slice().sort((a,b)=>a.day-b.day).map(tx=>{
                const sourceLabel = (tx.method==='Credito') ? (tx.card||'Sem cartÃ£o') : tx.method;
                return `
                  <tr>
                    <td style="color:#aaa">${pad2(tx.day)}</td>
                    <td>${escapeHtml(sourceLabel)}</td>
                    <td>${escapeHtml(tx.cat)}</td>
                    <td class="muted">${escapeHtml(tx.desc||'')}</td>
                    <td style="font-weight:bold; color:#e74c3c">${money(tx.val)}</td>
                  </tr>
                `;
            }).join('');
            tb.innerHTML = out || `<tr><td colspan="5" class="muted" style="text-align:center">Sem lanÃ§amentos.</td></tr>`;
        };

        sel.onchange = renderSource;
        selFrom.onchange = ()=>{ if(Number(selFrom.value)>Number(selTo.value)) selTo.value = selFrom.value; renderSource(); };
        selTo.onchange   = ()=>{ if(Number(selFrom.value)>Number(selTo.value)) selFrom.value = selTo.value; renderSource(); };
        renderSource();
    }
}

function renderDaily(){
  const m=getMonth(); document.getElementById('inpStartBalance').value=m.cfg.startBalance||''; document.getElementById('selWeekendFactor').value=m.cfg.weekendFactor||1;
  const {metas,totals,saldo}=computeDailyMetaAndSaldo(m);
  const dim=daysInMonth(state.year,state.month);
  const today=new Date(); const isCur=(today.getFullYear()===state.year&&today.getMonth()===state.month);
  
  if(isCur && today.getDate()<=dim){
    const d=today.getDate(); const w=(today.getDay()===0||today.getDay()===6);
    document.getElementById('dailyMeta').textContent=money(metas[d-1]);
    document.getElementById('dailyMetaHint').textContent=(w&&m.cfg.weekendFactor>1)?`ğŸ¹ Finde (${m.cfg.weekendFactor}x)`:'';
  } else { document.getElementById('dailyMeta').textContent='â€”'; document.getElementById('dailyMetaHint').textContent=''; }
  document.getElementById('dailySaldo').textContent=money(saldo);

  const tb=document.getElementById('dailyTable'); tb.innerHTML='';
  const labels = []; const activeCats = new Set(); const rawData = {}; 

  for(let d=1; d<=dim; d++){
      labels.push(d); rawData[d] = {};
      const list = m.txByDay[String(d)] || [];
      const manualVal = Number(m.manualDaily[String(d)]||0);
      list.forEach(tx => { if(tx.type === 'saida'){ activeCats.add(tx.cat); rawData[d][tx.cat] = (rawData[d][tx.cat] || 0) + tx.val; } });
      if(manualVal > 0){ activeCats.add('Manual'); rawData[d]['Manual'] = (rawData[d]['Manual'] || 0) + manualVal; }
      
      const dt=new Date(state.year,state.month,d); const w=(dt.getDay()===0||dt.getDay()===6);
      const total = dayTotalFromTx(list) + (list.length?0:manualVal);
      const hasTx = list.length > 0;
      const meta = metas[d-1]||0;
      const obs = hasTx ? dayObsFromTx(list) : '';
      const stC = (!hasTx && manualVal===0) ? '#444' : ((meta - total < 0) ? '#e74c3c' : '#2ecc71');
      const stL = (!hasTx && manualVal===0) ? 'â€”' : ((meta - total < 0) ? 'Excedeu' : 'OK');
      
      const tr=document.createElement('tr');
      if(isCur&&d===today.getDate()) tr.classList.add('today'); if(w) tr.classList.add('row-weekend');
      tr.innerHTML=`<td style="white-space:nowrap;font-weight:800;color:#aaa">${pad2(d)} ${w?'ğŸ¹':''} <span class="pill" style="border-color:${stC};color:${stC}">${stL}</span></td><td style="font-weight:800;color:${w?'var(--weekend)':'var(--accent)'}">${money(meta)}</td><td><button class="btn ${hasTx?'primary':''}" onclick="openDayModal(${d})" style="width:100%">${hasTx?money(total):(total!==0?money(total)+'*':'+')}</button></td><td><div class="obs-cell-wrap" onclick="this.classList.toggle('expanded')">${escapeHtml(obs||(total!==0?'Manual':'â€”'))}</div></td>`;
      tb.appendChild(tr);
  }

  const datasets = Array.from(activeCats).map(cat => ({ label: cat, data: labels.map(d => rawData[d][cat] || 0), backgroundColor: (cat === 'Manual') ? '#95a5a6' : getCatColor(cat), borderRadius: 2 }));
  if(datasets.length === 0) datasets.push({ data:[], label:'' });

  if(hasChart()){
    const ctx=document.getElementById('chartDaily').getContext('2d'); safeDestroy(charts.daily);
    charts.daily=new Chart(ctx,{type:'bar',data:{ labels, datasets },options:{responsive:true, maintainAspectRatio:false,scales:{x:{ stacked:true, grid:{display:false}, ticks:{autoSkip:false,maxRotation:90,font:{size:10}} },y:{ stacked:true, grid:{color:'#333'} }},plugins:{ legend:{display:false}, tooltip:{mode:'index', intersect:false} }}});
    
    const s=buildMonthlySummary(m);
    const cats=Object.keys(s.cats).sort((a,b)=>s.cats[b]-s.cats[a]); const vals=cats.map(c=>s.cats[c]);
    const pieCtx=document.getElementById('chartDailyPie').getContext('2d'); safeDestroy(charts.dailyPie);
    charts.dailyPie=new Chart(pieCtx,{type:'doughnut',data:{labels:cats,datasets:[{data:vals,backgroundColor:cats.map(c=>getCatColor(c)),borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,layout:{padding:10},plugins:{legend:{display:false}}}});
    
    const tot=vals.reduce((a,b)=>a+b,0)||1;
  }
}

function renderMonthly(){
  const m=getMonth(); document.getElementById('inpAdiant').value=m.incomes.adiant||''; document.getElementById('inpSal').value=m.incomes.sal||''; document.getElementById('txtNotes').value=m.notes||'';
  renderTableDynamic('tblExtras',m.incomes.extras,'extras'); renderTableDynamic('tblFixed',m.expenses.fixed,'fixed'); renderTableDynamic('tblCards',m.expenses.cards,'cards');
  const s=buildMonthlySummary(m);
  document.getElementById('mIncome').textContent=money(s.income); document.getElementById('mFixed').textContent=money(s.fixedTotal); document.getElementById('mDaily').textContent=money(s.dailyTotal);
  const elS=document.getElementById('mSobra'); elS.textContent=money(s.sobra); elS.style.color=s.sobra<0?'#e74c3c':'#2ecc71';
  
  if(hasChart()){
    const mc=document.getElementById('chartMacro').getContext('2d'); safeDestroy(charts.macro);
    const macroData = [s.fixedOnly, s.cardsOnly, s.dailyTotal, Math.max(0, s.sobra)];
    const macroColors = ['#c0392b', '#e74c3c', '#9b59b6', '#333'];
    charts.macro=new Chart(mc,{type:'doughnut',data:{labels:['Fixos', 'CartÃµes', 'DiÃ¡rio', 'Sobra'],datasets:[{ data: macroData, backgroundColor: macroColors, borderWidth:0 }]},options:{responsive:true, maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'#aaa', font:{size:10}}}}}});
    
    const yearly = getYearlyData();
    const bc=document.getElementById('chartYearlyBar').getContext('2d'); safeDestroy(charts.yearlyBar);
    charts.yearlyBar=new Chart(bc,{type:'bar',data:{labels: yearly.labels,datasets:[{ label: 'Fixos', data: yearly.fixed, backgroundColor: '#c0392b' },{ label: 'CartÃ£o', data: yearly.cards, backgroundColor: '#e74c3c' },{ label: 'DiÃ¡rio', data: yearly.daily, backgroundColor: '#9b59b6' }]},options:{responsive:true, maintainAspectRatio:false,scales:{ x:{stacked:true}, y:{stacked:true, display:false} },plugins:{ legend:{position:'bottom', labels:{color:'#aaa', font:{size:9}}}, tooltip:{mode:'index', intersect:false} }}});
  }
  const pigsTotal = sumPigs(ensurePigsModel(m));
  const totalPagar = s.fixedTotal + s.dailyTotal;
  const sobraPos = s.income - totalPagar;
  const sobraComPigs = sobraPos + pigsTotal;

  document.getElementById('macroRanking').innerHTML = `<div style="display:flex;justify-content:space-between;border-bottom:1px solid #222;padding:8px 0;font-size:.9rem"><div>ğŸ’° Receitas</div><div style="color:var(--primary)">${money(s.income)}</div></div><div style="display:flex;justify-content:space-between;border-bottom:1px solid #222;padding:8px 0;font-size:.9rem"><div>ğŸ”’ Fixos <span class="muted" style="font-size:0.7em">(Boleto)</span></div><div style="color:#c0392b">${money(s.fixedOnly)}</div></div><div style="display:flex;justify-content:space-between;border-bottom:1px solid #222;padding:8px 0;font-size:.9rem"><div>ğŸ’³ CartÃµes</div><div style="color:#e74c3c">${money(s.cardsOnly)}</div></div><div style="display:flex;justify-content:space-between;border-bottom:1px solid #222;padding:8px 0;font-size:.9rem"><div>ğŸ’¸ DiÃ¡rio</div><div style="color:#9b59b6">${money(s.dailyTotal)}</div></div><div style="display:flex;justify-content:space-between;padding:8px 0;font-size:1rem;font-weight:bold;margin-top:5px"><div>ğŸ“Œ Total a pagar</div><div style="color:#e74c3c">${money(s.fixedTotal + s.dailyTotal)}</div></div><div style="display:flex;justify-content:space-between;border-top:1px solid #222;padding:10px 0;font-size:1rem;font-weight:900"><div>âœ… Sobra (apÃ³s pagar)</div><div style="color:${sobraPos>=0?'var(--primary)':'var(--secondary)'}">${money(sobraPos)}</div></div><div style="display:flex;justify-content:space-between;padding:8px 0;font-size:1rem;font-weight:900"><div>ğŸ· Sobra + Porquinhos</div><div style="color:${sobraComPigs>=0?'var(--primary)':'var(--secondary)'}">${money(sobraComPigs)}</div></div>`;
  renderPigsUI();
}
// === PORQUINHOS / CDB (por banco) ===
function ensurePigsModel(model){
  if(!model.pigsByBank) model.pigsByBank = {};
  if(!state.db.pigsBanks) state.db.pigsBanks = [...(state.db.cards||defaultCards)];
  // garante todas as chaves atuais
  (state.db.pigsBanks||[]).forEach(b=>{ if(model.pigsByBank[b]===undefined) model.pigsByBank[b]=0; });
  // remove bancos que foram deletados da lista (se deletou, some da UI e dos cÃ¡lculos)
  Object.keys(model.pigsByBank).forEach(b=>{ if(!(state.db.pigsBanks||[]).includes(b)) delete model.pigsByBank[b]; });
  return model.pigsByBank;
}
function prevMonthKey(y,m){
  const d = new Date(y, m, 1);
  d.setMonth(d.getMonth()-1);
  return monthKey(d.getFullYear(), d.getMonth());
}
function sumPigs(map){
  return Object.values(map||{}).reduce((a,v)=>a + (Number(v)||0), 0);
}
function renderPigsUI(){
  const model = getMonth();
  const pigs = ensurePigsModel(model);

  const totalPigs = sumPigs(pigs);
  const sobra = buildMonthlySummary(model).sobra || 0;
  const totalFinal = totalPigs + sobra;

  const sumBox = document.getElementById('pigsSummary');
  if(sumBox){
    sumBox.style.display = '';
    sumBox.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <div style="font-weight:800">ğŸ· Total porquinhos/CDB</div>
        <div style="font-weight:900;color:var(--accent)">${money(totalPigs)}</div>
      </div>
      <div class="muted" style="margin-top:6px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div>ğŸ“¦ Total do mÃªs <span class="muted">(sobra + porquinhos)</span></div>
        <div style="font-weight:900;color:${totalFinal>=0?'var(--primary)':'var(--secondary)'}">${money(totalFinal)}</div>
      </div>
    `;
  }

  const tbody = document.getElementById('pigsTable');
  if(!tbody) return;
  const banks = Object.keys(pigs).sort((a,b)=>a.localeCompare(b,'pt-BR'));
  tbody.innerHTML = banks.map(b=>`
    <tr>
      <td style="font-weight:800;color:#aaa">${escapeHtml(b)}</td>
      <td>
        <input type="number" step="0.01" value="${Number(pigs[b])||0}"
          onchange="updPigValue('${encodeURIComponent(b)}', this.value)" />
      </td>
      <td style="text-align:right">
        <button class="btn danger" onclick="delPigBank('${encodeURIComponent(b)}')"
          style="padding:4px 8px;font-size:0.8rem">X</button>
      </td>
    </tr>
  `).join('');
}
window.updPigValue = (bank, val) => {
  bank = decodeURIComponent(bank);
  const model = getMonth(); ensurePigsModel(model);
  const n = Number(val)||0;
  model.pigsByBank[bank] = n;
  saveDB();
  renderPigsUI();
};
window.delPigBank = (bank) => {
  bank = decodeURIComponent(bank);
  if(!confirm('Excluir este banco do porquinho?')) return;
  // remove da lista principal
  state.db.pigsBanks = (state.db.pigsBanks||[]).filter(b=>b!==bank);
  // remove os dados desse banco em TODOS os meses (para nÃ£o reaparecer)
  Object.keys(state.db.months||{}).forEach(k=>{
    const mm = state.db.months[k];
    if(mm && mm.pigsByBank && mm.pigsByBank[bank] !== undefined) delete mm.pigsByBank[bank];
  });
  saveDB();
  renderPigsUI();
  // atualiza nÃºmeros do mensal/resultado se estiver visÃ­vel
  try{ renderMonthly(); }catch(e){}
};
function addPigBank(){
  const inp = document.getElementById('newPigBank');
  if(!inp) return;
  const v = (inp.value||'').trim();
  if(!v) return;
  if(!state.db.pigsBanks) state.db.pigsBanks = [];
  if(state.db.pigsBanks.includes(v)) return;
  state.db.pigsBanks.push(v);
  inp.value='';
  // garante chave no mÃªs atual
  const model = getMonth(); ensurePigsModel(model);
  if(model.pigsByBank[v]===undefined) model.pigsByBank[v]=0;
  saveDB();
  renderPigsUI();
}

function renderAll(){ ensureMonthModel(state.year,state.month); renderDaily(); renderMonthly(); renderReports(); }
function legacyExists(){ if(lsGet(LEG_MAIN_KEY))return true; for(let y=2025;y<=2030;y++)for(let m=0;m<12;m++)if(lsGet(LEG_DETAILS_PREFIX+`${m}_${y}`)||lsGet(LEG_CFG_PREFIX+`${m}_${y}`))return true; return false; }
function migrateLegacyToV9(){ if(lsGet(DB_KEY))return; const n={version:10,categories:[...defaultCats],months:{}}; for(let y=2025;y<=2030;y++)for(let m=0;m<12;m++){ const k=monthKey(y,m), cr=lsGet(LEG_CFG_PREFIX+`${m}_${y}`), dr=lsGet(LEG_DETAILS_PREFIX+`${m}_${y}`); if(cr||dr){ n.months[k]={cfg:{startBalance:0,weekendFactor:1},incomes:{adiant:0,sal:0,extras:[]},expenses:{fixed:[],cards:[]},notes:"",txByDay:{},manualDaily:{}}; if(cr)try{const c=JSON.parse(cr);n.months[k].cfg.startBalance=Number(c.start)||0;n.months[k].cfg.weekendFactor=Number(c.weekendFactor)||1;}catch{} if(dr)try{const d=JSON.parse(dr);Object.keys(d).forEach(x=>{n.months[k].txByDay[x]=(d[x]||[]).map(t=>({id:t.id||uid(),val:Number(t.val)||0,type:t.type||'saida',cat:t.cat||'Outros',method:t.method||'Pix',desc:t.desc||'',isPig:!!t.isPig,ts:Date.now()}));});}catch{} } } const vr=lsGet(LEG_MAIN_KEY); if(vr)try{const v=JSON.parse(vr);for(let m=0;m<12;m++){if(v[m]){const k=monthKey(2026,m);if(!n.months[k])n.months[k]={cfg:{startBalance:0,weekendFactor:1},incomes:{adiant:0,sal:0,extras:[]},expenses:{fixed:[],cards:[]},notes:"",txByDay:{},manualDaily:{}}; const s=v[m]; n.months[k].incomes.adiant=Number(s.adiant)||0;n.months[k].incomes.sal=Number(s.sal)||0;n.months[k].incomes.extras=(s.extraIncomes||[]).map(x=>({desc:x.desc||'Ext',val:Number(x.val)||0}));n.months[k].expenses.cards=(s.cards||[]).map(x=>({desc:x.desc||'Card',val:Number(x.val)||0}));n.months[k].expenses.fixed=(s.fixed||[]).map(x=>({desc:x.desc||'Fix',val:Number(x.val)||0,paid:!!x.paid}));n.months[k].notes=s.notes||''; if(s.daily)s.daily.forEach((dv,di)=>{if(Number(dv)&&(!n.months[k].txByDay[String(di+1)]||!n.months[k].txByDay[String(di+1)].length))n.months[k].manualDaily[String(di+1)]=Number(dv);});}}}catch{} lsSet(DB_KEY,JSON.stringify(n)); }
function setupMigrationNotice(){ if(!lsGet(DB_KEY)&&legacyExists()){ const n=document.getElementById('migrationNotice'); n.style.display=''; document.getElementById('btnMigrate').onclick=()=>{migrateLegacyToV9();location.reload();}; document.getElementById('btnDismissNotice').onclick=()=>n.style.display='none'; } }

(function init(){ state.db=loadDB(); initTheme(); setupSelectors(); setupTabs(); setupDailyConfig(); document.querySelectorAll('.section-bar').forEach(b=>b.addEventListener('click',e=>{if(!e.target.closest('button'))b.parentElement.classList.toggle('collapsed');})); setupModal(); setupMonthly(); setupMigrationNotice(); document.getElementById('btnExport').onclick=exportV9; document.getElementById('btnImport').onclick=importV9; if(location.protocol.startsWith('http')&&'serviceWorker'in navigator)navigator.serviceWorker.register('./service-worker.js').catch(()=>{}); renderAll(); })();
  </script>
</body>
</html>