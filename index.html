<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>FinApp (v10.3 Obs Expans√≠vel)</title>
  <meta name="theme-color" content="#121212" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --primary:#2ecc71; --secondary:#e74c3c; --bg:#121212; --card:#1e1e1e;
      --text:#e0e0e0; --accent:#38bdf8; --weekend:#9b59b6; --input-bg:#2c2c2c;
      --border:#333;
    }
    body{font-family:Segoe UI,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:12px;padding-bottom:90px}
    .container{max-width:1200px;margin:auto}
    header{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    h1{margin:0;font-size:1.1rem}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{background:#2c2c2c;color:#fff;border:1px solid #444;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.primary{background:rgba(56,189,248,.15);border-color:var(--accent);color:var(--accent);font-weight:700}
    .btn.warn{background:rgba(241,196,15,.12);border-color:#f1c40f;color:#f1c40f;font-weight:700}
    .btn.danger{background:rgba(231,76,60,.12);border-color:var(--secondary);color:var(--secondary);font-weight:700}
    select,input{background:var(--input-bg);border:1px solid #444;color:#fff;padding:10px;border-radius:10px;outline:none}
    .tabs{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
    .tab{background:var(--card);border:1px solid var(--border);color:#888;padding:8px 14px;border-radius:10px;cursor:pointer}
    .tab.active{background:rgba(56,189,248,.15);border-color:var(--accent);color:var(--accent);font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .card h3{margin:0;font-size:.7rem;opacity:.7;text-transform:uppercase}
    .card p{margin:8px 0 0;font-size:1.35rem;font-weight:800; transition: filter 0.3s;}
    .muted{opacity:.7;font-size:.85rem}
    
    /* SE√á√ïES RETR√ÅTEIS */
    .section{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden; transition: max-height 0.3s ease;}
    .section-bar{display:flex;justify-content:space-between;align-items:center;background:#252525;border-bottom:1px solid var(--border);padding:10px 14px;gap:10px; cursor:pointer; user-select:none;}
    .section-title{font-weight:800;color:var(--accent); display:flex; align-items:center; gap:8px;}
    .content{padding:14px;}
    .section.collapsed .content { display: none; }
    .section.collapsed .section-bar { border-bottom: none; }
    .toggle-icon { transition: transform 0.3s; font-size: 0.8rem; opacity: 0.7; }
    .section.collapsed .toggle-icon { transform: rotate(-90deg); }

    /* TABELA DI√ÅRIA FLUIDA COM OBS EXPANS√çVEL */
    .table-wrap { overflow-x: auto; border-radius:14px; border:1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; }
    
    td,th { border-bottom: 1px solid #2a2a2a; padding: 8px; font-size: 0.85rem; vertical-align: middle; }
    th { background: #252525; color: var(--accent); font-size: 0.75rem; text-align: left; white-space: nowrap; }
    
    /* O segredo da OBS */
    .obs-cell-wrap {
        max-width: 80px; /* Largura inicial pequena para n√£o quebrar a tabela */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #888;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        border: 1px solid transparent;
        transition: all 0.2s;
        font-size: 0.8rem;
    }
    
    /* Quando clicado (classe 'expanded' adicionada via JS) */
    .obs-cell-wrap.expanded {
        white-space: normal; /* Permite quebrar linha */
        max-width: 200px;    /* Cresce para caber o texto */
        color: #fff;
        background: #222;
        border-color: #444;
        position: relative;
        z-index: 10;
    }

    td input { width: 100%; box-sizing: border-box; padding: 8px; margin:0; }

    .pill{display:inline-block;border:1px solid #444;border-radius:999px;padding:2px 8px;font-size:.7rem;opacity:.85; font-weight:700;}
    .synced{color:var(--weekend);font-weight:800}
    .row-weekend{background:rgba(155,89,182,.05)}
    .today{background:rgba(56,189,248,.08);border-left:4px solid var(--accent)}
    
    .chart-box{height:260px; transition: filter 0.3s;}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 900px){ .split{grid-template-columns:1fr} }
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal.active{display:flex}
    .modal-card{width:min(680px,94vw);max-height:90vh;overflow:auto;background:#18181b;border:1px solid var(--border);border-radius:14px;padding:14px}
    .modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);padding-bottom:10px;margin-bottom:12px;gap:10px}
    .tx-list{background:#121212;border:1px solid var(--border);border-radius:12px;padding:10px;max-height:260px;overflow:auto}
    .tx-item{display:flex;justify-content:space-between;gap:10px;padding:10px;border-bottom:1px solid #333}
    .tx-item:last-child{border-bottom:none}
    .tx-meta{font-size:.78rem;color:#888}
    .tx-actions button{background:none;border:none;cursor:pointer;font-size:1.05rem}
    .tx-actions .edit{color:#f1c40f}
    .tx-actions .del{color:var(--secondary)}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .full{grid-column:1/-1}
    .ok{background:var(--accent);color:#000;border:none}
    .cat-list-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-bottom:1px solid #333;background:#222;}
    .cat-list-item:first-child{border-top-left-radius:10px; border-top-right-radius:10px;}
    .cat-list-item:last-child{border-bottom:none;border-bottom-left-radius:10px; border-bottom-right-radius:10px;}
    .notice{background:rgba(56,189,248,.12);border:1px solid rgba(56,189,248,.4);border-radius:14px;padding:12px;margin-bottom:12px}

    /* PRIVACIDADE */
    body.privacy-global-active .card p,
    body.privacy-global-active td:nth-child(2), 
    body.privacy-global-active td:nth-child(3),
    body.privacy-global-active input:not([type="checkbox"]),
    body.privacy-global-active .chart-box,
    body.privacy-global-active #catRanking,
    body.privacy-global-active #dailyRanking {
        filter: blur(10px) !important;
        user-select: none;
        pointer-events: none;
    }
  
    /* MOBILE */
    @media (max-width: 520px){
      body{padding:10px;padding-bottom:90px}
      .container{max-width:100%}
      header{flex-direction:column;align-items:stretch}
      header .row{width:100%}
      header .row > *{flex:1;min-width:140px}
      .tabs{flex-wrap:nowrap;overflow:auto;-webkit-overflow-scrolling:touch}
      .tab{flex:1;text-align:center}
      .grid{grid-template-columns:1fr}
      .card p{font-size:1.25rem}
      .section-bar{flex-wrap:wrap;align-items:flex-start}
      .section-bar .btn{width:100%}
      
      input,select{width:100%;box-sizing:border-box}
      .form-grid{grid-template-columns:1fr}
      .chart-box{height:220px}
      .modal-card{width:96vw;padding:12px}
      .tx-item{flex-direction:column;align-items:flex-start}
      .tx-actions{width:100%;display:flex;justify-content:flex-end;gap:12px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="notice" id="migrationNotice" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <div>
          <b>Modo Preview:</b> nada √© migrado automaticamente.
          <div class="muted">Se voc√™ quiser testar com seus dados atuais, clique em ‚ÄúMigrar do legado‚Äù. Isso cria apenas a chave <span class="pill">finapp_db_v9</span> (n√£o apaga as antigas).</div>
        </div>
        <div class="row">
          <button class="btn warn" id="btnMigrate">Migrar do legado</button>
          <button class="btn" id="btnDismissNotice">Fechar</button>
        </div>
      </div>
    </div>

    <header>
      <h1>üì± FinApp (v10.3) <span class="pill">Obs Clique</span></h1>
      <div class="row">
        <select id="selYear"></select>
        <select id="selMonth"></select>
        <button class="btn" id="btnOpenCats" onclick="openCatModal()">üìÇ Cats</button>
        <button class="btn" id="btnMasterEye" onclick="toggleGlobalPrivacy()" title="Ocultar Valores">üëÅÔ∏è Mestre</button>
        <button class="btn" id="btnExport">üì• BKP</button>
        <button class="btn" id="btnImport">üì§ Rest</button>
      </div>
    </header>

    <div class="tabs">
      <button class="tab active" id="tabDaily">üìÖ Di√°rio</button>
      <button class="tab" id="tabMonthly">üìä Mensal</button>
    </div>

    <div id="viewDaily">
      <div class="grid" style="margin-bottom:12px">
        <div class="card">
          <h3>Meta Hoje</h3>
          <p id="dailyMeta">R$ 0,00</p>
          <div class="muted" id="dailyMetaHint"></div>
        </div>
        <div class="card">
          <h3>Saldo Restante</h3>
          <p id="dailySaldo">R$ 0,00</p>
          <div class="muted">Calculado no m√™s selecionado</div>
        </div>
        <div class="card">
          <h3>Saldo Inicial do Di√°rio</h3>
          <input id="inpStartBalance" type="number" style="width:100%; box-sizing:border-box; margin-top:8px" />
          <div class="muted" style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn warn" id="btnUseMonthlySobra">Usar (Receitas - Fixos)</button>
            <select id="selWeekendFactor">
              <option value="1">Finde 1x</option>
              <option value="1.5">Finde 1.5x</option>
              <option value="2">Finde 2x</option>
              <option value="3">Finde 3x</option>
            </select>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-bar">
          <div class="section-title"><span class="toggle-icon">‚ñº</span> üìâ Gr√°fico di√°rio</div>
          <span class="pill">gasto por dia</span>
        </div>
        <div class="content">
          <div class="chart-box"><canvas id="chartDaily"></canvas></div>
        </div>
      </div>

      <div class="section" style="margin-top:12px">
        <div class="section-bar">
          <div class="section-title"><span class="toggle-icon">‚ñº</span> üèÜ Ranking por Categoria</div>
        </div>
        <div class="content">
          <div class="chart-box" style="height:220px; margin-bottom:12px"><canvas id="chartDailyPie"></canvas></div>
          <div id="dailyRanking"></div>
        </div>
      </div>

      <div class="section" style="margin-top:12px">
        <div class="section-bar">
          <div class="section-title"><span class="toggle-icon">‚ñº</span> üìÖ Lan√ßamentos do m√™s</div>
          <button class="btn" id="btnGoToday">Hoje</button>
        </div>
        <div class="content">
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Dia</th>
                  <th>Meta</th>
                  <th>Total</th>
                  <th>Obs (Toque p/ ler)</th>
                </tr>
              </thead>
              <tbody id="dailyTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div id="viewMonthly" style="display:none">
      <div class="grid" style="margin-bottom:12px">
        <div class="card"><h3>Receitas</h3><p id="mIncome">R$ 0,00</p></div>
        <div class="card"><h3>Fixos + Cart√µes</h3><p id="mFixed">R$ 0,00</p></div>
        <div class="card"><h3>Di√°rio</h3><p id="mDaily">R$ 0,00</p></div>
        <div class="card"><h3>Sobra</h3><p id="mSobra">R$ 0,00</p></div>
      </div>

      <div class="split">
        <div class="section">
          <div class="section-bar"><div class="section-title"><span class="toggle-icon">‚ñº</span> üí∞ Receitas</div></div>
          <div class="content">
            <div class="form-grid">
              <input id="inpAdiant" type="number" placeholder="Adiant." />
              <input id="inpSal" type="number" placeholder="Sal√°rio" />
              <button class="btn full" id="btnAddExtra">+ Extra</button>
            </div>
            <div style="margin-top:10px; overflow:auto;">
              <table>
                <tbody id="tblExtras"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-bar"><div class="section-title"><span class="toggle-icon">‚ñº</span> üîí Fixas</div></div>
          <div class="content">
            <button class="btn" id="btnAddFixed" style="width:100%">+ Conta fixa</button>
            <div class="table-wrap" style="margin-top:10px">
              <table>
                <thead>
                    <tr>
                        <th style="width:30px; text-align:center">Pg</th>
                        <th>Descri√ß√£o</th>
                        <th style="width:85px">Valor</th>
                        <th style="width:35px"></th>
                    </tr>
                </thead>
                <tbody id="tblFixed"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-bar"><div class="section-title"><span class="toggle-icon">‚ñº</span> üí≥ Cart√µes</div></div>
          <div class="content">
            <button class="btn" id="btnAddCard" style="width:100%">+ Cart√£o</button>
            <div class="table-wrap" style="margin-top:10px">
              <table>
                <thead>
                    <tr>
                        <th>Descri√ß√£o</th>
                        <th style="width:85px">Valor</th>
                        <th style="width:35px"></th>
                    </tr>
                </thead>
                <tbody id="tblCards"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-bar"><div class="section-title"><span class="toggle-icon">‚ñº</span> üìä Vis√£o & Ranking</div></div>
          <div class="content">
            <div class="chart-box"><canvas id="chartMacro"></canvas></div>
            <div class="chart-box" style="height:150px; margin-top:12px"><canvas id="chartDailyBar"></canvas></div>
            <div id="catRanking" style="margin-top:10px"></div>
          </div>
        </div>
      </div>

      <div class="section" style="margin-top:12px">
        <div class="section-bar"><div class="section-title"><span class="toggle-icon">‚ñº</span> üìù Notas do m√™s</div></div>
        <div class="content">
          <textarea id="txtNotes" style="width:100%; box-sizing:border-box; min-height:120px; background:var(--input-bg); border:1px solid #444; color:#ddd; padding:12px; border-radius:12px; resize:none" placeholder="Digite suas notas e observa√ß√µes aqui..."></textarea>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="modalDay">
    <div class="modal-card">
      <div class="modal-header">
        <div><b>üìÖ Dia <span id="modalDayLabel"></span></b> <span class="pill" id="modalMonthLabel"></span></div>
        <button class="btn" id="btnCloseModal">Fechar</button>
      </div>
      <div class="tx-list" id="txList"></div>
      <div class="card" style="margin-top:12px">
        <h3 id="formTitle">Novo lan√ßamento</h3>
        <div class="form-grid" style="margin-top:10px">
          <select id="txType"><option value="saida">üí∏ Sa√≠da</option><option value="entrada">üí∞ Entrada</option></select>
          <input id="txVal" type="text" inputmode="decimal" placeholder="Valor (ex: 10+5)" />
          <select id="txCat"></select>
          <select id="txMethod">
            <option value="Pix">Pix</option><option value="Credito">Cr√©dito</option>
            <option value="Debito">D√©bito</option><option value="Dinheiro">Dinheiro</option>
          </select>
          <input id="txDesc" class="full" type="text" placeholder="Observa√ß√£o / Descri√ß√£o" />
          <label class="full muted" style="display:flex;gap:10px;align-items:center">
            <input id="txPig" type="checkbox" /> üê∑ Enviar para Porquinho
          </label>
          <button class="btn ok full" id="btnSaveTx">Adicionar / Salvar</button>
          <button class="btn full" id="btnCancelEdit" style="display:none">Cancelar edi√ß√£o</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="modalCats">
    <div class="modal-card">
      <div class="modal-header">
        <div><b>üìÇ Gerenciar Categorias</b></div>
        <button class="btn" onclick="document.getElementById('modalCats').classList.remove('active')">Fechar</button>
      </div>
      <div class="card">
        <h3>Adicionar Nova</h3>
        <div style="display:flex;gap:8px;margin-top:8px">
            <input id="newCatName" type="text" placeholder="Ex: üê∂ Pet" style="flex:1" />
            <button class="btn primary" id="btnAddCat">Adicionar</button>
        </div>
      </div>
      <h3 style="margin-top:16px;margin-bottom:8px">Categorias Existentes</h3>
      <div id="catListContainer" style="max-height:300px;overflow:auto;"></div>
    </div>
  </div>

  <script>
// ===== Mobile-safe wrappers =====
const __LS = (()=>{ try{ const t='__t__'; localStorage.setItem(t,'1'); localStorage.removeItem(t); return localStorage; }catch(e){ return null; } })();
function lsGet(k){ try{ return __LS ? __LS.getItem(k) : null; }catch(e){ return null; } }
function lsSet(k,v){ try{ if(__LS) __LS.setItem(k,v); }catch(e){} }
function hasChart(){ return typeof window.Chart !== 'undefined'; }
function safeDestroy(ch){ try{ ch && ch.destroy && ch.destroy(); }catch(e){} }

const DB_KEY = 'finapp_db_v9';
const monthsPT = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
const defaultCats = ['üõí Mercado','üçî Alimentacao','üöó Transporte','üç∫ Lazer','üè† Casa','üíä Saude','‚úàÔ∏è Viagem','‚öôÔ∏è Outros'];
const LEG_MAIN_KEY='financeDB_v8'; const LEG_CFG_PREFIX='survival_cfg_v4_'; const LEG_DETAILS_PREFIX='survival_details_v3_';

let state = { db: null, year: new Date().getFullYear(), month: new Date().getMonth(), editing: { day: null, txId: null } };
let charts = { daily:null, dailyPie:null, macro:null, dailyBar:null };

function toggleGlobalPrivacy() {
    const isActive = document.body.classList.toggle('privacy-global-active');
    const btn = document.getElementById('btnMasterEye');
    if(isActive){ btn.style.background='var(--secondary)'; btn.style.borderColor='var(--secondary)'; }
    else{ btn.style.background='#2c2c2c'; btn.style.borderColor='#444'; }
}

const pad2=(n)=>String(n).padStart(2,'0');
const monthKey=(y,m)=>`${y}-${pad2(m+1)}`;
const daysInMonth=(y,m)=>new Date(y, m+1, 0).getDate();
function money(v){ return (v||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}); }
function parseAmount(expr){
  const s=String(expr||'').replace(/\s+/g,'').replace(',', '.');
  if(!s)throw new Error('empty'); if(!/^[0-9+\-\.]+$/.test(s))throw new Error('invalid');
  const sum=(s.match(/[+\-]?\d*\.?\d+/g)||[]).reduce((a,p)=>a+(parseFloat(p)||0),0);
  if(!Number.isFinite(sum))throw new Error('invalid'); return sum;
}
function uid(){ return `${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`; }
function escapeHtml(str){ return String(str||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;"); }

function loadDB(){
  const raw=lsGet(DB_KEY); let data={version:10,categories:[...defaultCats],months:{}};
  if(raw){ try{ const parsed=JSON.parse(raw); data={...data,...parsed}; if(!data.categories) data.categories=[...defaultCats]; }catch{} }
  return data;
}
function saveDB(){ lsSet(DB_KEY, JSON.stringify(state.db)); }
function ensureMonthModel(y,m){
  const k=monthKey(y,m);
  if(!state.db.months[k]) state.db.months[k]={ cfg:{startBalance:0,weekendFactor:1}, incomes:{adiant:0,sal:0,extras:[]}, expenses:{fixed:[],cards:[]}, notes:"", txByDay:{}, manualDaily:{} };
  return state.db.months[k];
}
function getMonth(){ return ensureMonthModel(state.year, state.month); }

function sumExtras(list){ return (list||[]).reduce((a,x)=>a + (Number(x.val)||0),0); }
function sumCards(list){ return (list||[]).reduce((a,x)=>a + (Number(x.val)||0),0); }
function sumFixed(list){ return (list||[]).reduce((a,x)=>a + (Number(x.val)||0),0); }
function dayTotalFromTx(list){ return (list||[]).reduce((acc,tx)=>{ const v=Number(tx.val)||0; return acc+(tx.type==='entrada'?-v:v); },0); }
function dayObsFromTx(list){ if(!list||!list.length)return ''; return list.map(tx=>`${tx.cat} ${tx.desc?`(${tx.desc})`:''}`).join(' ‚Ä¢ '); }

function buildMonthlySummary(model){
  const income=(Number(model.incomes.adiant)||0)+(Number(model.incomes.sal)||0)+sumExtras(model.incomes.extras);
  const fixed=sumFixed(model.expenses.fixed)+sumCards(model.expenses.cards);
  const dim=daysInMonth(state.year, state.month);
  const bar=[]; const cats={}; let dailyTotal=0;
  for(let d=1; d<=dim; d++){
    const list=model.txByDay[String(d)];
    let dv=0;
    if(list&&list.length){
      dv=dayTotalFromTx(list);
      list.forEach(tx=>{ if(tx.type==='saida') cats[tx.cat]=(cats[tx.cat]||0)+(Number(tx.val)||0); });
    } else dv=Number(model.manualDaily[String(d)]||0);
    bar.push(dv); dailyTotal+=dv;
  }
  return {income,fixed,dailyTotal,sobra:income-fixed-dailyTotal,bar,cats};
}

function computeDailyMetaAndSaldo(model){
  const dim=daysInMonth(state.year, state.month);
  const start=Number(model.cfg.startBalance)||0; const factor=Number(model.cfg.weekendFactor)||1;
  let saldo=start; const metas=[]; const totals=[];
  for(let day=1; day<=dim; day++){
    const list=model.txByDay[String(day)];
    const total=(list&&list.length)?dayTotalFromTx(list):Number(model.manualDaily[String(day)]||0);
    totals.push(total);
    let wd=0, we=0;
    for(let k=day; k<=dim; k++){ const dow=new Date(state.year,state.month,k).getDay(); if(dow===0||dow===6)we++; else wd++; }
    const w=wd+(we*factor); const base=w>0?(saldo/w):0;
    const isW=(new Date(state.year,state.month,day).getDay()===0||new Date(state.year,state.month,day).getDay()===6);
    metas.push(isW?base*factor:base);
    saldo-=total;
  }
  return {metas,totals,saldo};
}

function exportV9(){ saveDB(); const b=new Blob([JSON.stringify(state.db,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`FINAPP_BKP_${monthKey(state.year,state.month)}.json`; a.click(); }
function importV9(){
  const i=document.createElement('input'); i.type='file'; i.accept='.json';
  i.onchange=e=>{ const f=e.target.files[0]; if(!f)return; const r=new FileReader(); r.onload=ev=>{ try{ const o=JSON.parse(ev.target.result); if(!o||!o.months)throw 0; lsSet(DB_KEY,JSON.stringify(o)); location.reload(); }catch{alert('Erro no arquivo');} }; r.readAsText(f); }; i.click();
}

function setupSelectors(){
  const sy=document.getElementById('selYear'), sm=document.getElementById('selMonth');
  sy.innerHTML=''; for(let y=2025;y<=2030;y++) sy.add(new Option(y,y)); sy.value=state.year;
  sm.innerHTML=monthsPT.map((m,i)=>`<option value="${i}">${m}</option>`).join(''); sm.value=state.month;
  sy.onchange=()=>{state.year=Number(sy.value);renderAll();}; sm.onchange=()=>{state.month=Number(sm.value);renderAll();};
}
function setupTabs(){
  const td=document.getElementById('tabDaily'), tm=document.getElementById('tabMonthly'), vd=document.getElementById('viewDaily'), vm=document.getElementById('viewMonthly');
  td.onclick=()=>{td.classList.add('active');tm.classList.remove('active');vd.style.display='';vm.style.display='none';renderDaily();};
  tm.onclick=()=>{tm.classList.add('active');td.classList.remove('active');vm.style.display='';vd.style.display='none';renderMonthly();};
}
function setupDailyConfig(){
  const i=document.getElementById('inpStartBalance'), s=document.getElementById('selWeekendFactor'), b=document.getElementById('btnUseMonthlySobra');
  i.onchange=()=>{getMonth().cfg.startBalance=Number(i.value)||0;saveDB();renderDaily();};
  s.onchange=()=>{getMonth().cfg.weekendFactor=Number(s.value)||1;saveDB();renderDaily();};
  b.onclick=()=>{const m=getMonth(), sm=buildMonthlySummary(m); m.cfg.startBalance=Math.max(0,sm.income-sm.fixed); saveDB();renderDaily();};
  document.getElementById('btnGoToday').onclick=()=>{
    const t=new Date(); if(t.getFullYear()!==state.year||t.getMonth()!==state.month){alert('M√™s errado');return;}
    const el=document.querySelector('tr.today'); if(el)el.scrollIntoView({behavior:'smooth',block:'center'});
  };
}

function openCatModal(){ document.getElementById('modalCats').classList.add('active'); renderCatManager(); }
function renderCatManager(){
    document.getElementById('catListContainer').innerHTML=(state.db.categories||[]).map((c,i)=>`<div class="cat-list-item"><span>${escapeHtml(c)}</span><button class="btn danger" onclick="delCat(${i})">üóëÔ∏è</button></div>`).join('');
}
function addCat(){
    const v=document.getElementById('newCatName').value.trim();
    if(v && !state.db.categories.includes(v)){ state.db.categories.push(v); saveDB(); document.getElementById('newCatName').value=''; renderCatManager(); }
}
window.delCat=(i)=>{if(confirm('Excluir cat?')){state.db.categories.splice(i,1);saveDB();renderCatManager();}};

function openDayModal(d){
  state.editing.day=d; state.editing.txId=null;
  document.getElementById('modalDayLabel').textContent=pad2(d); document.getElementById('modalMonthLabel').textContent=`${monthsPT[state.month]}/${state.year}`;
  const sel=document.getElementById('txCat'); sel.innerHTML=(state.db.categories||[]).map(c=>`<option>${escapeHtml(c)}</option>`).join('');
  document.getElementById('modalDay').classList.add('active');
  resetTxForm(); renderTxList(getMonth().txByDay[String(d)]||[]);
}
function closeDayModal(){ document.getElementById('modalDay').classList.remove('active'); renderDaily(); }
function resetTxForm(){ document.getElementById('formTitle').textContent='Novo'; document.getElementById('txVal').value=''; document.getElementById('txDesc').value=''; document.getElementById('txPig').checked=false; document.getElementById('btnCancelEdit').style.display='none'; state.editing.txId=null; }
function renderTxList(l){
  const b=document.getElementById('txList');
  if(!l||!l.length){ b.innerHTML='<div class="muted" style="text-align:center;padding:10px">Vazio</div>'; return; }
  b.innerHTML=l.map(x=>`<div class="tx-item"><div><b style="color:${x.type==='entrada'?'var(--primary)':'#fff'}">${x.type==='entrada'?'+':'-'} ${money(x.val)}</b><div class="tx-meta">${x.cat} ${x.isPig?'(üê∑)':''}</div>${x.desc?`<div>${escapeHtml(x.desc)}</div>`:''}</div><div class="tx-actions"><button class="edit" onclick="editTx('${x.id}')">‚úèÔ∏è</button><button class="del" onclick="delTx('${x.id}')">üóëÔ∏è</button></div></div>`).join('');
}
window.editTx=(id)=>{
  const tx=(getMonth().txByDay[String(state.editing.day)]||[]).find(x=>x.id===id); if(!tx)return;
  state.editing.txId=id; document.getElementById('formTitle').textContent='Editar';
  document.getElementById('txType').value=tx.type; document.getElementById('txVal').value=tx.val; document.getElementById('txMethod').value=tx.method; document.getElementById('txDesc').value=tx.desc||''; document.getElementById('txPig').checked=!!tx.isPig; document.getElementById('btnCancelEdit').style.display='';
  const sel=document.getElementById('txCat'); if(![...sel.options].some(o=>o.value===tx.cat)) sel.add(new Option(tx.cat,tx.cat)); sel.value=tx.cat;
};
window.delTx=(id)=>{ if(confirm('Apagar?')){ const m=getMonth(), d=String(state.editing.day); m.txByDay[d]=m.txByDay[d].filter(x=>x.id!==id); saveDB(); renderTxList(m.txByDay[d]); resetTxForm(); } };

function saveTx(){
  const m=getMonth(), d=String(state.editing.day); let amt; try{amt=parseAmount(document.getElementById('txVal').value);}catch{alert('Valor err');return;}
  const tx={ id:state.editing.txId||uid(), val:Math.abs(amt), type:document.getElementById('txType').value, cat:document.getElementById('txCat').value, method:document.getElementById('txMethod').value, desc:document.getElementById('txDesc').value||'', isPig:document.getElementById('txPig').checked, ts:Date.now() };
  if(!m.txByDay[d]) m.txByDay[d]=[];
  if(state.editing.txId){ const i=m.txByDay[d].findIndex(x=>x.id===state.editing.txId); if(i>=0)m.txByDay[d][i]=tx; } else m.txByDay[d].push(tx);
  delete m.manualDaily[d]; saveDB(); renderTxList(m.txByDay[d]); resetTxForm();
}

function setupModal(){
  document.getElementById('btnCloseModal').onclick=closeDayModal; document.getElementById('btnSaveTx').onclick=saveTx;
  document.getElementById('btnCancelEdit').onclick=()=>{state.editing.txId=null;resetTxForm();};
  document.getElementById('btnAddCat').onclick=addCat;
  document.getElementById('modalCats').addEventListener('click',e=>{if(e.target.id==='modalCats')document.getElementById('modalCats').classList.remove('active');});
}

function setupMonthly(){
  const ia=document.getElementById('inpAdiant'), is=document.getElementById('inpSal'), tn=document.getElementById('txtNotes');
  const up=()=>{ getMonth().incomes.adiant=Number(ia.value)||0; getMonth().incomes.sal=Number(is.value)||0; saveDB(); renderMonthly(); };
  ia.onchange=up; is.onchange=up; tn.onchange=()=>{getMonth().notes=tn.value;saveDB();};
  document.getElementById('btnAddExtra').onclick=()=>{getMonth().incomes.extras.push({desc:'Novo',val:0});saveDB();renderMonthly();};
  document.getElementById('btnAddFixed').onclick=()=>{getMonth().expenses.fixed.push({desc:'Nova',val:0,paid:false});saveDB();renderMonthly();};
  document.getElementById('btnAddCard').onclick=()=>{getMonth().expenses.cards.push({desc:'Cart√£o',val:0});saveDB();renderMonthly();};
}

function renderTableDynamic(id,list,k){
  const tb=document.getElementById(id); tb.innerHTML='';
  list.forEach((x,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`${k==='fixed'?`<td style="vertical-align:middle;text-align:center"><input type="checkbox" ${x.paid?'checked':''} onchange="updList('${k}',${i},'paid',this.checked)" style="width:auto;margin:0"></td>`:''}<td><input type="text" value="${escapeHtml(x.desc)}" onchange="updList('${k}',${i},'desc',this.value)" class="m-desc" ${x.paid?'style="text-decoration:line-through;opacity:0.6"':''}></td><td><input type="number" step="0.01" value="${x.val}" onchange="updList('${k}',${i},'val',this.value)" class="m-val"></td><td style="text-align:right"><button class="btn danger" onclick="delList('${k}',${i})" style="padding:4px 8px;font-size:0.8rem">X</button></td>`;
    tb.appendChild(tr);
  });
}
window.updList=(k,i,f,v)=>{ const l=k==='extras'?getMonth().incomes.extras:(k==='fixed'?getMonth().expenses.fixed:getMonth().expenses.cards); l[i][f]=f==='val'?Number(v)||0:v; saveDB(); renderMonthly(); };
window.delList=(k,i)=>{ if(confirm('Apagar?')){ const l=k==='extras'?getMonth().incomes.extras:(k==='fixed'?getMonth().expenses.fixed:getMonth().expenses.cards); l.splice(i,1); saveDB(); renderMonthly(); } };

function renderDaily(){
  const m=getMonth(); document.getElementById('inpStartBalance').value=m.cfg.startBalance||''; document.getElementById('selWeekendFactor').value=m.cfg.weekendFactor||1;
  const {metas,totals,saldo}=computeDailyMetaAndSaldo(m);
  const dim=daysInMonth(state.year,state.month);
  const today=new Date(); const isCur=(today.getFullYear()===state.year&&today.getMonth()===state.month);
  
  if(isCur && today.getDate()<=dim){
    const d=today.getDate(); const w=(today.getDay()===0||today.getDay()===6);
    document.getElementById('dailyMeta').textContent=money(metas[d-1]);
    document.getElementById('dailyMetaHint').textContent=(w&&m.cfg.weekendFactor>1)?`üçπ Finde (${m.cfg.weekendFactor}x)`:'';
  } else { document.getElementById('dailyMeta').textContent='‚Äî'; document.getElementById('dailyMetaHint').textContent=''; }
  document.getElementById('dailySaldo').textContent=money(saldo);

  const tb=document.getElementById('dailyTable'); tb.innerHTML='';
  const labels=[], data=[], colors=[];
  
  for(let d=1; d<=dim; d++){
    const dt=new Date(state.year,state.month,d); const w=(dt.getDay()===0||dt.getDay()===6);
    const list=m.txByDay[String(d)]||[]; const hasTx=list.length>0;
    const total=hasTx?dayTotalFromTx(list):Number(m.manualDaily[String(d)]||0);
    const meta=metas[d-1]||0; const obs=hasTx?dayObsFromTx(list):'';
    const isOver=(meta-total)<0;
    const stC=(!hasTx&&total===0)?'#444':(isOver?'#e74c3c':'#2ecc71');
    const stL=(!hasTx&&total===0)?'‚Äî':(isOver?'Excedeu':'OK');
    
    labels.push(d); data.push((hasTx||total!==0)?total:null); colors.push((total>meta*1.1)?'#e74c3c':(w?'#9b59b6':'#2ecc71'));
    
    const tr=document.createElement('tr');
    if(isCur&&d===today.getDate()) tr.classList.add('today'); if(w) tr.classList.add('row-weekend');
    tr.innerHTML=`
      <td style="white-space:nowrap;font-weight:800;color:#aaa">${pad2(d)} ${w?'üçπ':''} <span class="pill" style="border-color:${stC};color:${stC}">${stL}</span></td>
      <td style="font-weight:800;color:${w?'var(--weekend)':'var(--accent)'}">${money(meta)}</td>
      <td><button class="btn ${hasTx?'primary':''}" onclick="openDayModal(${d})" style="width:100%">${hasTx?money(total):(total!==0?money(total)+'*':'+')}</button></td>
      <td>
         <div class="obs-cell-wrap" onclick="this.classList.toggle('expanded')">
            ${escapeHtml(obs||(total!==0?'Manual':'‚Äî'))}
         </div>
      </td>
    `;
    tb.appendChild(tr);
  }

  if(hasChart()){
    const ctx=document.getElementById('chartDaily').getContext('2d'); safeDestroy(charts.daily);
    charts.daily=new Chart(ctx,{type:'bar',data:{labels,datasets:[{data,backgroundColor:colors,borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{grid:{color:'#333'}},x:{grid:{display:false},ticks:{autoSkip:false,maxRotation:90,font:{size:10}}}}}});
    
    const s=buildMonthlySummary(m);
    const cats=Object.keys(s.cats).sort((a,b)=>s.cats[b]-s.cats[a]); const vals=cats.map(c=>s.cats[c]);
    const pieCtx=document.getElementById('chartDailyPie').getContext('2d'); safeDestroy(charts.dailyPie);
    charts.dailyPie=new Chart(pieCtx,{type:'doughnut',data:{labels:cats,datasets:[{data:vals,backgroundColor:['#e74c3c','#f1c40f','#2ecc71','#3498db','#9b59b6','#e67e22','#1abc9c'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,layout:{padding:10},plugins:{legend:{display:false}}}});
    
    const tot=vals.reduce((a,b)=>a+b,0)||1;
    document.getElementById('dailyRanking').innerHTML=cats.map((c,i)=>{
      const v=vals[i]||0, p=(v/tot*100).toFixed(1);
      return `<div style="display:flex;justify-content:space-between;border-bottom:1px solid #222;padding:6px 0;font-size:.85rem"><div>${c}</div><div><b>${money(v)}</b> <span class="muted">(${p}%)</span></div></div>`;
    }).join('');
  }
}

function renderMonthly(){
  const m=getMonth(); document.getElementById('inpAdiant').value=m.incomes.adiant||''; document.getElementById('inpSal').value=m.incomes.sal||''; document.getElementById('txtNotes').value=m.notes||'';
  renderTableDynamic('tblExtras',m.incomes.extras,'extras'); renderTableDynamic('tblFixed',m.expenses.fixed,'fixed'); renderTableDynamic('tblCards',m.expenses.cards,'cards');
  const s=buildMonthlySummary(m);
  document.getElementById('mIncome').textContent=money(s.income); document.getElementById('mFixed').textContent=money(s.fixed); document.getElementById('mDaily').textContent=money(s.dailyTotal);
  const elS=document.getElementById('mSobra'); elS.textContent=money(s.sobra); elS.style.color=s.sobra<0?'#e74c3c':'#2ecc71';
  
  if(hasChart()){
    const mc=document.getElementById('chartMacro').getContext('2d'); safeDestroy(charts.macro);
    charts.macro=new Chart(mc,{type:'doughnut',data:{labels:['Fixo+Cart√£o','Di√°rio','Sobra'],datasets:[{data:[s.fixed,s.dailyTotal,Math.max(0,s.sobra)],backgroundColor:['#e74c3c','#9b59b6','#333'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'#aaa'}}}}});
    const bc=document.getElementById('chartDailyBar').getContext('2d'); safeDestroy(charts.dailyBar);
    charts.dailyBar=new Chart(bc,{type:'bar',data:{labels:s.bar.map((_,i)=>i+1),datasets:[{data:s.bar,backgroundColor:'#9b59b6',borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{display:false},x:{ticks:{color:'#444',font:{size:8},autoSkip:false}}}}});
  }
  const cats=Object.keys(s.cats).sort((a,b)=>s.cats[b]-s.cats[a]); const vals=cats.map(c=>s.cats[c]); const tot=vals.reduce((a,b)=>a+b,0)||1;
  document.getElementById('catRanking').innerHTML=cats.map((c,i)=>{
    const v=vals[i]||0, p=(v/tot*100).toFixed(1);
    return `<div style="display:flex;justify-content:space-between;border-bottom:1px solid #222;padding:6px 0;font-size:.85rem"><div>${c}</div><div><b>${money(v)}</b> <span class="muted">(${p}%)</span></div></div>`;
  }).join('');
}

function renderAll(){ ensureMonthModel(state.year,state.month); renderDaily(); renderMonthly(); }
function legacyExists(){ if(lsGet(LEG_MAIN_KEY))return true; for(let y=2025;y<=2030;y++)for(let m=0;m<12;m++)if(lsGet(LEG_DETAILS_PREFIX+`${m}_${y}`)||lsGet(LEG_CFG_PREFIX+`${m}_${y}`))return true; return false; }
function migrateLegacyToV9(){
  if(lsGet(DB_KEY))return; const n={version:10,categories:[...defaultCats],months:{}};
  for(let y=2025;y<=2030;y++)for(let m=0;m<12;m++){
    const k=monthKey(y,m), cr=lsGet(LEG_CFG_PREFIX+`${m}_${y}`), dr=lsGet(LEG_DETAILS_PREFIX+`${m}_${y}`);
    if(cr||dr){ n.months[k]={cfg:{startBalance:0,weekendFactor:1},incomes:{adiant:0,sal:0,extras:[]},expenses:{fixed:[],cards:[]},notes:"",txByDay:{},manualDaily:{}};
      if(cr)try{const c=JSON.parse(cr);n.months[k].cfg.startBalance=Number(c.start)||0;n.months[k].cfg.weekendFactor=Number(c.weekendFactor)||1;}catch{}
      if(dr)try{const d=JSON.parse(dr);Object.keys(d).forEach(x=>{n.months[k].txByDay[x]=(d[x]||[]).map(t=>({id:t.id||uid(),val:Number(t.val)||0,type:t.type||'saida',cat:t.cat||'Outros',method:t.method||'Pix',desc:t.desc||'',isPig:!!t.isPig,ts:Date.now()}));});}catch{}
    }
  }
  const vr=lsGet(LEG_MAIN_KEY);
  if(vr)try{const v=JSON.parse(vr);for(let m=0;m<12;m++){if(v[m]){const k=monthKey(2026,m);if(!n.months[k])n.months[k]={cfg:{startBalance:0,weekendFactor:1},incomes:{adiant:0,sal:0,extras:[]},expenses:{fixed:[],cards:[]},notes:"",txByDay:{},manualDaily:{}}; const s=v[m]; n.months[k].incomes.adiant=Number(s.adiant)||0;n.months[k].incomes.sal=Number(s.sal)||0;n.months[k].incomes.extras=(s.extraIncomes||[]).map(x=>({desc:x.desc||'Ext',val:Number(x.val)||0}));n.months[k].expenses.cards=(s.cards||[]).map(x=>({desc:x.desc||'Card',val:Number(x.val)||0}));n.months[k].expenses.fixed=(s.fixed||[]).map(x=>({desc:x.desc||'Fix',val:Number(x.val)||0,paid:!!x.paid}));n.months[k].notes=s.notes||''; if(s.daily)s.daily.forEach((dv,di)=>{if(Number(dv)&&(!n.months[k].txByDay[String(di+1)]||!n.months[k].txByDay[String(di+1)].length))n.months[k].manualDaily[String(di+1)]=Number(dv);});}}}catch{}
  lsSet(DB_KEY,JSON.stringify(n));
}
function setupMigrationNotice(){
  if(!lsGet(DB_KEY)&&legacyExists()){ const n=document.getElementById('migrationNotice'); n.style.display=''; document.getElementById('btnMigrate').onclick=()=>{migrateLegacyToV9();location.reload();}; document.getElementById('btnDismissNotice').onclick=()=>n.style.display='none'; }
}

(function init(){
  state.db=loadDB(); setupSelectors(); setupTabs(); setupDailyConfig(); document.querySelectorAll('.section-bar').forEach(b=>b.addEventListener('click',e=>{if(!e.target.closest('button'))b.parentElement.classList.toggle('collapsed');}));
  setupModal(); setupMonthly(); setupMigrationNotice();
  document.getElementById('btnExport').onclick=exportV9; document.getElementById('btnImport').onclick=importV9;
  if(location.protocol.startsWith('http')&&'serviceWorker'in navigator)navigator.serviceWorker.register('./service-worker.js').catch(()=>{});
  renderAll();
})();
  </script>
</body>
</html>
